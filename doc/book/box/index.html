




<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>3. Database</title>
    <link rel="icon" type="image/png" sizes="192x192"
          href="/theme/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32"
          href="/theme/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96"
          href="/theme/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16"
          href="/theme/favicon/favicon-16x16.png">
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
      
      
    </script>
    <script id="dsq-count-scr"
            src="//tarantooldb.disqus.com/count.js" async/>
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/jquery.pin.min.js"></script>
    <script type="text/javascript" src="../../_static/headers.js"></script>
    <link rel="stylesheet" href="/theme/design.css">
    <link rel="stylesheet" href="/theme/pygmentize.css">
    <link rel="stylesheet" href="/theme/font-awesome.min.css">
    <link rel="stylesheet" href="../../_static/sphinx_design.css">
     
    <!--[if lt IE 9]>
      <script src="/js/ie8.js"></script>
      <link rel="stylesheet" href="/theme/ie8.css" />
    <![endif]-->
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-22120502-1', 'auto');
  ga('send', 'pageview');
</script>

<!-- Rating@Mail.ru counter -->
<script type="text/javascript">
  var _tmr = _tmr || [];
  _tmr.push({id: "2284916", type: "pageView", start: (new Date()).getTime()});
  (function (d, w) {
    var ts = d.createElement("script"); ts.type = "text/javascript"; ts.async = true;
    ts.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//top-fwz1.mail.ru/js/code.js";
    var f = function () {var s = d.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ts, s);};
    if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); }
  })(document, window);
</script>
<noscript>
  <div style="position:absolute;left:-10000px;">
    <img src="//top-fwz1.mail.ru/counter?id=2284916;js=na" style="border:0;"
         height="1" width="1" alt="Рейтинг@Mail.ru" />
  </div>
</noscript>
<!-- //Rating@Mail.ru counter -->


  </head>
  
  <body class="p-cols_design">
  
    <div class="b-wrapper">
      <!-- HEADER > -->
      <header class="b-header">
        <div class="b-header-wrapper">
          <nav class="b-header_menu">
            
  <ul class="b-menu">
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org" class="b-menu-item-url">Overview</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/doc/" class="b-menu-item-url p-active">Documentation</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/download.html" class="b-menu-item-url">Download</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/careers.html" class="b-menu-item-url">Careers</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
        
      </li>
    
  </ul>

          </nav>
        </div>
      </header>
      <!-- < HEADER -->

      <div class="b-content b-clearbox">
        
  <section class="b-lightgray_block b-documentation_top b-clearbox p-documentation_in">
    <div class="b-block-wrapper">
      <h2 class="b-section-title b-ellipsis" title="3. Database">
        3. Database
      </h2>
  <div class="b-doc-language_selector">
    <ul class="b-doc-language_selector-list">
    
      <li class="b-doc-language_selector-item">
      
        <a href="
  
    ../../../book/box/index.html
  
"
           class="b-doc-language_selector-item-url p-active"> En </a>
      
      </li>
    
      <li class="b-doc-language_selector-item">
      
        <a href="
  
    ../../ru/book/box/index.html
  
"
           class="b-doc-language_selector-item-url"> Ru </a>
      
      </li>
    
    </ul>
  </div>
</div>
  </section>
  
    <div class="b-cols_content b-clearbox b-doc-book/box/index">
      <div class="b-cols_content_left">
        
<form id="searchbox" role="search" class="search b-search" action="../../search.html" method="get">
  <input class="b-search-text" name="q" type="text"/ placeholder="Search the manual">
  <input class="b-search-but" type="submit" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>


        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro.html">1. Preface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user_guide_getting_started.html">2. Getting started</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3. Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../replication/index.html">4. Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.html">5. Configuration reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../administration.html">6. Server administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../connectors/index.html">7. Connectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules.html">8. Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app/a_errcodes.html">9. Appendix A. List of error codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app/b_internals.html">10. Appendix B. Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app/c_lua_tutorial.html">11. Appendix C. Lua tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app/d_vinyl/index.html">12. Appendix D. Vinyl</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app/e_cookbook.html">13. Appendix E. Cookbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app/f_c_tutorial.html">14. Appendix F. C tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app/g_changes.html">15. Appendix G. Version-specific changes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference_lua/index.html">Lua reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference_rock/index.html">Lua rocks reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference_capi/index.html">C API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guide/index.html">Contributing</a></li>
</ul>

      </div>
      <div class="b-cols_content_right">
        <div class="b-cols_content_right-slot">
  <div class="b-page_header">
    <ul class="b-path-list">
      <li class="b-path-list-item">
        <a href="../../index.html"
           class="b-path-list-item-url">
          Documentation
        </a>
      </li>
      
        <li class="b-path-list-item">
          <a href="../index.html"
             class="b-path-list-item-url b-ellipsis">
            User Guide
          </a>
        </li>
      
      
      <li class="b-path-list-item">
        <div title="3. Database" class="b-path_current b-ellipsis">
          3. Database
        </div>
      </li>
      
    </ul>
  </div>

  <div class="section" id="database">
<span id="database-chapter"></span><h1>3. Database<a class="headerlink" href="#database" title="Permalink to this headline">¶</a></h1>
<p>This chapter describes how Tarantool stores values and what operations with data
it supports.</p>
<div class="section" id="document-data-model">
<h2>3.1. Document data model<a class="headerlink" href="#document-data-model" title="Permalink to this headline">¶</a></h2>
<p>If you tried out the
<a class="reference internal" href="../user_guide_getting_started.html#user-guide-getting-started-first-database"><span class="std std-ref">Starting Tarantool and making your first database</span></a>
exercise from the last chapter, then your database looks like this:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>+--------------------------------------------+
|                                            |
| SPACE &#39;tester&#39;                             |
| +----------------------------------------+ |
| |                                        | |
| | TUPLE SET &#39;tester&#39;                     | |
| | +-----------------------------------+  | |
| | | Tuple: [ 1 ]                      |  | |
| | | Tuple: [ 2, &#39;Music&#39; ]             |  | |
| | | Tuple: [ 3, &#39;length&#39;, 93 ]        |  | |
| | +-----------------------------------+  | |
| |                                        | |
| | INDEX &#39;primary&#39;                        | |
| | +-----------------------------------+  | |
| | | Key: 1                            |  | |
| | | Key: 2                            |  | |
| | | Key: 3                            |  | |
| | +-----------------------------------+  | |
| |                                        | |
| +----------------------------------------+ |
+--------------------------------------------+
</pre></div>
</div>
<div class="section" id="space">
<h3>3.1.1. Space<a class="headerlink" href="#space" title="Permalink to this headline">¶</a></h3>
<p>A <em>space</em> -- 'tester' in the example -- is a container.</p>
<p>When Tarantool is being used to store data, there is always at least one space.
There can be many spaces. Each space has a unique name specified by the user.
Each space has a unique numeric identifier which can be specified by the user
but usually is assigned automatically by Tarantool. Spaces always contain one
tuple set and one or more indexes.</p>
</div>
<div class="section" id="tuple-set">
<h3>3.1.2. Tuple set<a class="headerlink" href="#tuple-set" title="Permalink to this headline">¶</a></h3>
<p>A <em>tuple set</em> -- 'tester' in the example -- is a group of tuples.</p>
<p>There is always one tuple set in a space. The identifier of a tuple set is the
same as the space name -- 'tester' in the example.</p>
<p>A tuple fills the same role as a “row” or a “record”, and the components of a
tuple (which we call “fields”) fill the same role as a “row column” or “record
field”, except that: the fields of a tuple can be composite structures, such as
arrays or maps and don't need to have names. That's why there was no need to
pre-define the tuple set when creating the space, and that's why each tuple can
have a different number of elements. Tuples are stored as <a class="reference external" href="https://en.wikipedia.org/wiki/MessagePack">MsgPack</a> arrays.</p>
<p>Any given tuple may have any number of fields and the fields may have a variety
of types. The identifier of a field is the field's number, base 1. For example
“1” can be used in some contexts to refer to the first field of a tuple.</p>
<p>When Tarantool returns a tuple value, it surrounds strings with single quotes,
separates fields with commas, and encloses the tuple inside square brackets.
For example: <code class="docutils literal"><span class="pre">[3,</span> <span class="pre">'length',</span> <span class="pre">93]</span></code>.</p>
</div>
<div class="section" id="index">
<span id="index-box-index"></span><h3>3.1.3. Index<a class="headerlink" href="#index" title="Permalink to this headline">¶</a></h3>
<p>An <em>index</em> -- 'primary' in the example -- is a group of key values and pointers.</p>
<p>In order for a tuple set to be useful, there must always be at least one index
in a space. There can be many indexes. As with spaces, the user can and should
specify the index name, and let Tarantool come up with a unique numeric identifier
(the &quot;index id&quot;). In our example there is one index and its name is “primary”.</p>
<p>An index may be <em>multi-part</em>, that is, the user can declare that an index key
value is taken from two or more fields in the tuple, in any order. An index may
be <em>unique</em>, that is, the user can declare that it would be illegal to have the
same key value twice. An index may have <em>one of four types</em>: HASH which is
fastest and uses the least memory but must be unique, TREE which allows
partial-key searching and ordered results, BITSET which can be good for searches
that contain '=' and multiple ANDed conditions, and RTREE for spatial coordinates.
The first index is called the “<em>primary key</em>” index and it must be unique; all
other indexes are called “secondary” indexes.</p>
<p>An index definition may include identifiers of tuple fields and their expected
types. The allowed types for indexed fields are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">unsigned</span></code> (unsigned integer between 0 and 18,446,744,073,709,551,615)</li>
<li><code class="docutils literal"><span class="pre">integer</span></code> (signed integer between -9,223,372,036,854,775,808 and 9,223,372,036,854,775,807)</li>
<li><code class="docutils literal"><span class="pre">number</span></code> (unsigned integer or signed integer or floating-point value)</li>
<li><code class="docutils literal"><span class="pre">string</span></code> (string, any sequence of octets)</li>
<li><code class="docutils literal"><span class="pre">scalar</span></code> (boolean or number or string)</li>
<li><code class="docutils literal"><span class="pre">array</span></code> (a series of numbers for use with <a class="reference internal" href="box_index.html#box-index-rtree"><span class="std std-ref">RTREE indexes</span></a>)</li>
</ul>
<p>Take our example, which has the request:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hash&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
</pre></div>
</div>
<p>The effect is that, for all tuples in tester, field number 1 must exist and must
contain an unsigned integer.</p>
<p>Space definitions and index definitions are stored permanently in system spaces.
It is possible to add, drop, or alter the definitions at runtime, with some
restrictions. The syntax details for defining spaces and indexes are in section
<a class="reference internal" href="#index-box-library"><span class="std std-ref">The box library</span></a>.</p>
</div>
<div class="section" id="data-types">
<h3>3.1.4. Data types<a class="headerlink" href="#data-types" title="Permalink to this headline">¶</a></h3>
<p>Tarantool can work with numbers, strings, booleans, tables, and userdata.</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="18%" />
<col width="41%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">General type</th>
<th class="head">Specific type</th>
<th class="head">What Lua <code class="docutils literal"><span class="pre">type()</span></code> would return</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>scalar</td>
<td>number</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.3.html">number</a>&quot;</td>
<td>12345</td>
</tr>
<tr class="row-odd"><td>scalar</td>
<td>string</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.4.html">string</a>&quot;</td>
<td>'A B C'</td>
</tr>
<tr class="row-even"><td>scalar</td>
<td>boolean</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.2.html">boolean</a>&quot;</td>
<td>true</td>
</tr>
<tr class="row-odd"><td>scalar</td>
<td>nil</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.1.html">nil</a>&quot;</td>
<td>nil</td>
</tr>
<tr class="row-even"><td>compound</td>
<td>Lua table</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.5.html">table</a>&quot;</td>
<td>table: 0x410f8b10</td>
</tr>
<tr class="row-odd"><td>compound</td>
<td>tuple</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/28.1.html">Userdata</a>&quot;</td>
<td>12345: {'A B C'}</td>
</tr>
</tbody>
</table>
<p>In Lua, a <em>number</em> is double-precision floating-point, but Tarantool allows both
integer and floating-point values. Tarantool will try to store a number as
floating-point if the value contains a decimal point or is very large (greater
than 100 billion = 1e14), otherwise Tarantool will store it as an integer. To
ensure that even very large numbers will be treated as integers, use the
<a class="reference internal" href="../../reference_lua/other.html#other-tonumber64"><span class="std std-ref">tonumber64</span></a> function, or the <code class="docutils literal"><span class="pre">LL</span></code> (Long Long) suffix,
or the <code class="docutils literal"><span class="pre">ULL</span></code> (Unsigned Long Long) suffix. Here are examples of numbers using
regular notation, exponential notation, the ULL suffix, and the tonumber64
function: <code class="docutils literal"><span class="pre">-55</span></code>, <code class="docutils literal"><span class="pre">-2.7e+20</span></code>, <code class="docutils literal"><span class="pre">100000000000000ULL</span></code>,
<code class="docutils literal"><span class="pre">tonumber64('18446744073709551615')</span></code>.</p>
<p>For database storage, Tarantool uses MsgPack rules. Storage is variable-length,
so the smallest number requires only one byte but the largest number requires
nine bytes. When a field has an 'unsigned' index, all values must be unsigned integers
between 0 and 18,446,744,073,709,551,615.</p>
<p>A <em>string</em> is a variable-length sequence of bytes, usually represented with
alphanumeric characters inside single quotes.</p>
<p>A <em>boolean</em> is either <code class="docutils literal"><span class="pre">true</span></code> or <code class="docutils literal"><span class="pre">false</span></code>.</p>
<p>A <em>nil</em> type has only one possible value, also called <em>nil</em>, but often displayed
as <em>null</em>. Nils may be compared to values of any types with == (is-equal) or
~= (is-not-equal), but other operations will not work. Nils may not be used in
Lua tables; the workaround is to use <a class="reference internal" href="../../reference_lua/yaml.html#yaml-null"><span class="std std-ref">yaml.NULL</span></a> or
<a class="reference internal" href="../../reference_lua/json.html#json-null"><span class="std std-ref">json.NULL</span></a> or <a class="reference internal" href="../../reference_lua/msgpack.html#msgpack-null"><span class="std std-ref">msgpack.NULL</span></a>.</p>
<p>A <em>tuple</em> is returned in YAML format like <code class="docutils literal"><span class="pre">-</span> <span class="pre">[120,</span> <span class="pre">'a',</span> <span class="pre">'b',</span> <span class="pre">'c']</span></code>. A few
functions may return tables with multiple tuples. A scalar may be converted to a
tuple with only one field. A Lua table may contain all of a tuple's fields, but
not nil.</p>
<p>Some of the data types may be used in <a class="reference internal" href="box_space.html#details-about-index-field-types"><span class="std std-ref">indexed fields</span></a>.</p>
<p>For more tuple examples see <a class="reference internal" href="box_tuple.html#box-tuple"><span class="std std-ref">box.tuple</span></a>.</p>
</div>
<div class="section" id="operations">
<h3>3.1.5. Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h3>
<p>The basic operations are: the five data-change operations (<code class="docutils literal"><span class="pre">insert</span></code>, <code class="docutils literal"><span class="pre">update</span></code>,
<code class="docutils literal"><span class="pre">upsert</span></code>, <code class="docutils literal"><span class="pre">delete</span></code>, <code class="docutils literal"><span class="pre">replace</span></code>), and the data-retrieval operation (<code class="docutils literal"><span class="pre">select</span></code>).
There are also minor operations like “ping” which can only be used with the
binary protocol. Also, there are <a class="reference internal" href="box_index.html#box-index-index-pairs"><span class="std std-ref">index iterator</span></a>
operations, which can only be used with Lua code. (Index iterators are for
traversing indexes one key at a time, taking advantage of features that are
specific to an index type, for example evaluating Boolean expressions when
traversing BITSET indexes, or going in descending order when traversing TREE
indexes.)</p>
<p>Six examples of basic operations:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- Add a new tuple to tuple set tester.</span>
<span class="go">-- The first field, field[1], will be 999 (type is unsigned).</span>
<span class="go">-- The second field, field[2], will be &#39;Taranto&#39; (type is string).</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Taranto&#39;</span><span class="p">}</span>

<span class="go">-- Update the tuple, changing field field[2].</span>
<span class="go">-- The clause &quot;{999}&quot;, which has the value to look up in</span>
<span class="go">-- the index of the tuple&#39;s primary-key field, is mandatory</span>
<span class="go">-- because update() requests must always have a clause that</span>
<span class="go">-- specifies the primary key, which in this case is field[1].</span>
<span class="go">-- The clause &quot;{{&#39;=&#39;, 2, &#39;Tarantino&#39;}}&quot; specifies that assignment</span>
<span class="go">-- will happen to field[2] with the new value.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantino&#39;</span><span class="p">}})</span>

<span class="go">-- Upsert the tuple, changing field field[2] again.</span>
<span class="go">-- The syntax of upsert is similar to the syntax of update,</span>
<span class="go">-- but the return value will be different.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">upsert</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantism&#39;</span><span class="p">}})</span>

<span class="go">-- Replace the tuple, adding a new field.</span>
<span class="go">-- This is also possible with the update() request but</span>
<span class="go">-- the update() request is usually more complicated.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantella&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantula&#39;</span><span class="p">}</span>

<span class="go">-- Retrieve the tuple.</span>
<span class="go">-- The clause &quot;{999}&quot; is still mandatory, although it does not have to</span>
<span class="go">-- mention the primary key.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>

<span class="go">-- Delete the tuple.</span>
<span class="go">-- Once again the clause to identify the primary-key field is mandatory.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>
</pre></div>
</div>
<p>How does Tarantool do a basic operation? Let's take this example:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">3</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">size&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">}})</span>
</pre></div>
</div>
<p>which, for those who know SQL, is equivalent to a statement like</p>
<div class="highlight-SQL"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">tester</span> <span class="k">SET</span> <span class="ss">&quot;field[2]&quot;</span> <span class="o">=</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="ss">&quot;field[3]&quot;</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">WHERE</span> <span class="ss">&quot;field[[1]&quot;</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<ol class="arabic simple">
<li>If this is happening on a remote client, then the client parses the statement
and changes it to a binary-protocol instruction which has already been
checked, and which the server can understand without needing to parse
everything again. The client ships a packet to the server.</li>
<li>The server's “transaction processor” thread uses the primary-key index on
field[1] to find the location of the tuple in memory. It determines that the
tuple can be updated (not much can go wrong when you're merely changing an
unindexed field value to something shorter).</li>
<li>The transaction processor thread sends a message to the write-ahead logging
(WAL) thread.</li>
</ol>
<p>At this point, a <em>yield</em> takes place. To know the significance of that -- and
it's quite significant -- you have to know a few facts and a few new words.</p>
<div class="fact admonition">
<p class="first admonition-title">FACT 1:</p>
<p class="last">There is only one transaction processor thread. Some people are used to the
idea that there can be multiple threads operating on the database, with
(say) thread #1 reading row #x while thread #2 writes row #y. With Tarantool
no such thing ever happens. Only the transaction processor thread can access
the database, and there is only one transaction processor thread for each
instance of the server.</p>
</div>
<div class="fact admonition">
<p class="first admonition-title">FACT 2:</p>
<p class="last">The transaction processor thread can handle many <em>fibers</em>. A fiber is a set
of computer instructions that may contain &quot;yield&quot; signals. The transaction
processor thread will execute all computer instructions until a yield, then
switch to execute the instructions of a different fiber. Thus (say) the
thread reads row #x for the sake of fiber #1, then writes row #y for the sake
of fiber #2.</p>
</div>
<div class="fact admonition" id="index-yields-must-happen">
<p class="first admonition-title">FACT 3:</p>
<p class="last">Yields must happen, otherwise the transaction processor thread would stick
permanently on the same fiber. There are <a class="reference internal" href="atomic.html#atomic-the-implicit-yield-rules"><span class="std std-ref">implicit yields</span></a>:
every data-change operation or network-access causes an implicit yield, and
every statement that goes through the tarantool client causes an implicit
yield. And there are explicit yields: in a Lua function one can and should
add “yield” statements to prevent hogging. This is called <em>cooperative multitasking</em>.</p>
</div>
<p>Since all data-change operations end with an implicit yield and an implicit
commit, and since no data-change operation can change more than one tuple, there
is no need for any locking. Consider, for example, a Lua function that does
three Tarantool operations:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>             <span class="c1">-- this does not yield and does not commit</span>
<span class="n">s</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="o">...</span><span class="p">},{{</span><span class="o">...</span><span class="p">}})</span>   <span class="c1">-- this yields and commits</span>
<span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>             <span class="c1">-- this does not yield and does not commit</span>
</pre></div>
</div>
<p>The combination “SELECT plus UPDATE” is an atomic transaction: the function
holds a consistent view of the database until the UPDATE ends. For the
combination “UPDATE plus SELECT” the view is not consistent, because after the
UPDATE the transaction processor thread can switch to another fiber, and delete
the tuple that was just updated.</p>
<p>Note re storage engine: vinyl handles yields differently, see
<a class="reference internal" href="vinyl_diff.html#vinyl-diff"><span class="std std-ref">differences between memtx and vinyl</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Note re multi-request transactions</p>
<p class="last">there is a way to delay yields, see
<a class="reference internal" href="atomic.html#atomic-atomic-execution"><span class="std std-ref">Atomic execution</span></a>.</p>
</div>
<p>Since locks don't exist, and disk writes only involve the write-ahead log,
transactions are usually fast. Also the Tarantool server may not be using up all
the threads of a powerful multi-core processor, so advanced users may be able to
start a second Tarantool server on the same processor without ill effects.</p>
<p>Additional examples of requests can be found in the Tarantool regression test suite
(<a class="reference external" href="https://github.com/tarantool/tarantool/tree/1.7/test/box">https://github.com/tarantool/tarantool/tree/1.7/test/box</a>).
A complete grammar of supported data-manipulation functions will come later in this chapter.</p>
<p>Since not all Tarantool operations can be expressed with the data-manipulation
functions, or with Lua, to gain complete access to data manipulation
functionality one must use a
<a class="reference internal" href="../connectors/index.html#index-box-connectors"><span class="std std-ref">Perl, PHP, Python or other programming language connector</span></a>.
The client/server protocol is open and documented. See this
<a class="reference internal" href="../../dev_guide/box_protocol.html#box-protocol-iproto-protocol"><span class="std std-ref">annotated BNF</span></a>.</p>
</div>
<div class="section" id="saving-to-disk">
<h3>3.1.6. Saving to disk<a class="headerlink" href="#saving-to-disk" title="Permalink to this headline">¶</a></h3>
<p>Tarantool maintains a set of write-ahead log (WAL) files. There is a separate
thread -- the WAL writer -- which catches all requests that can change a
database, such as <code class="docutils literal"><span class="pre">box.schema.create</span></code> or <code class="docutils literal"><span class="pre">box.space.insert</span></code>. Ordinarily the
WAL writer writes the request, along with administrative fields and flags, to a
WAL file immediately. This ensures data persistence, because, even if an
in-memory database is lost when the power goes off, Tarantool recovers it
automatically when it starts up again, by reading the WAL files and redoing the
requests (this is called the &quot;recovery process&quot;).
Users can change the timing of the WAL writer, or turn it off, by setting
<a class="reference internal" href="../configuration/index.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a>.</p>
<p>Tarantool also maintains a set of snapshot files. A snapshot file is an on-disk
copy of the entire data set for a given moment. Instead of reading every WAL
file since the databases were created, the recovery process can load the latest
snapshot and then read only the WAL files that were produced after the snapshot
was made. A snapshot can be made even if there is no WAL file. Some snapshots
are automatic, or users can make them at any time with the
<a class="reference internal" href="admin.html#admin-snapshot"><span class="std std-ref">box.snapshot()</span></a> request.</p>
<p>Details about the WAL writer and the recovery process are in the
<a class="reference internal" href="../app/b_internals.html#b-internals"><span class="std std-ref">Internals</span></a> section.</p>
</div>
<div class="section" id="data-manipulation">
<h3>3.1.7. Data manipulation<a class="headerlink" href="#data-manipulation" title="Permalink to this headline">¶</a></h3>
<p>The basic <em>data-manipulation</em> requests are: <code class="docutils literal"><span class="pre">insert</span></code>, <code class="docutils literal"><span class="pre">replace</span></code>, <code class="docutils literal"><span class="pre">update</span></code>,
<code class="docutils literal"><span class="pre">upsert</span></code>, <code class="docutils literal"><span class="pre">delete</span></code>, <code class="docutils literal"><span class="pre">select</span></code>. All of them are part of the <code class="docutils literal"><span class="pre">box</span></code> library.
Most of them may return data. Usually both inputs and outputs are Lua tables.</p>
<p>The Lua syntax for data-manipulation functions can vary. Here are examples of
the variations with <code class="docutils literal"><span class="pre">select</span></code> requests; the same rules exist for the other
data-manipulation functions. Every one of the examples does the same thing:
select a tuple set from a space named 'tester' where the primary-key field value
equals 1. For the examples there is an assumption that the numeric id of 'tester'
is 512, which happens to be the case in our sandbox example only.</p>
<p id="index-object-reference">First, there are five <em>object reference variations</em>:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- #1 module . submodule . name</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #2 replace name with a literal in square brackets</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #3 replace name with a numeric id in square brackets</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="mi">512</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #4 use a variable instead of a literal for the name</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">variable</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #5 use a variable for the entire object reference</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>Later examples in this manual will usually have the &quot;<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">tester</span></em><span class="pre">:</span></code>&quot;
form (#1); however, this is a matter of user preference and all the variations
exist in the wild.</p>
<p>Later descriptions in this manual will use the syntax &quot;<code class="docutils literal"><span class="pre">space_object:</span></code>&quot;
for references to objects which are spaces as in the above examples, and
&quot;<code class="docutils literal"><span class="pre">index_object:</span></code>&quot; for references to objects which are indexes (for example
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">tester</span></em><span class="pre">.index.</span><em><span class="pre">primary</span></em><span class="pre">:</span></code>).</p>
<p>Then, there are seven <em>parameter variations</em>:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- #1</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #2</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">})</span>
<span class="go">-- #3</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">-- #4</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="go">-- #5</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">},{</span><span class="n">iterator</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">EQ&#39;</span><span class="p">})</span>
<span class="go">-- #6</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="n">variable</span><span class="p">}</span>
<span class="go">-- #7</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
</pre></div>
</div>
<p>The primary-key value is enclosed in braces, and if it was a multi-part primary
key then the value would be multi-part, for example <code class="docutils literal"><span class="pre">...select{1,2,3}</span></code>. The
braces can be enclosed inside parentheses — <code class="docutils literal"><span class="pre">...select({...})</span></code> — which are
optional unless it is necessary to pass something besides the primary-key value,
as in example #5. Literal values such as 1 (a scalar value) or {1} (a Lua table
value) may be replaced by variable names, as in examples #6 and #7. Although
there are special cases where braces can be omitted, they are preferable because
they signal &quot;Lua table&quot;. Examples and descriptions in this manual have the &quot;{1}&quot;
form; however, this too is a matter of user preference and all the variations
exist in the wild.</p>
<p>All the data-manipulation functions operate on tuple sets but, since primary
keys are unique, the number of tuples in the tuple set is always 0 or 1. The
only exception is <code class="docutils literal"><span class="pre">box.space...select</span></code>, which may accept either a primary-key
value or a secondary-key value.</p>
</div>
<div class="section" id="index-operations">
<h3>3.1.8. Index operations<a class="headerlink" href="#index-operations" title="Permalink to this headline">¶</a></h3>
<p>Index operations are automatic: if a data-manipulation request changes a tuple,
then it also changes the index keys defined for the tuple. Therefore the user
only needs to know how and why to define.</p>
<p>The simple index-creation operation which has been illustrated before is</p>
<pre class="highlight literal-block">
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:create_index('</span><em><span class="pre">index-name</span></em><span class="pre">')</span></code>
</pre>
<p>By default, this creates a unique &quot;tree&quot; index on the first field of all tuples
(often called &quot;Field#1&quot;), which is assumed to be numeric.</p>
<p>These variations exist:</p>
<ol class="arabic">
<li><p class="first">An indexed field may be a string rather than a number.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:create_index('</span><em><span class="pre">index-name</span></em><span class="pre">',</span> <span class="pre">{parts</span> <span class="pre">=</span> <span class="pre">{1,</span> <span class="pre">'string'}})</span></code>
</pre>
<p>For an ordinary index, the most common data types are 'unsigned' = any
non-negative integer, or 'string' = any series of bytes. Numbers are
ordered according to their point on the number line -- so 2345 is greater
than 500 -- while strings are ordered according to the encoding of the first
byte then the encoding of the second byte then the encoding of the third byte
and so on -- so '2345' is less than '500'.</p>
<p>For details about other index types see <a class="reference internal" href="box_space.html#box-space-create-index"><span class="std std-ref">create_index</span></a>.</p>
</li>
<li><p class="first">There may be more than one field.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:create_index('</span><em><span class="pre">index-name</span></em><span class="pre">',</span> <span class="pre">{</span>
&nbsp;&nbsp;&nbsp; <span class="pre">parts</span> <span class="pre">=</span> <span class="pre">{3,</span> <span class="pre">'unsigned',</span> <span class="pre">2,</span> <span class="pre">'string'}</span>
<span class="pre">})</span></code>
</pre>
<p>For an ordinary index, the maximum number of parts is 255. The specification
of each part consists of a field number and a type.</p>
</li>
<li><p class="first">The index does not have to be unique.</p>
<pre class="highlight literal-block">
box.space.*space-name*:create_index('<em>index-name</em>', { unique = false })
</pre>
<p>The first index of a tuple set must be unique, but other indexes (&quot;secondary&quot;
indexes) may be non-unique.</p>
</li>
<li><p class="first">The index does not have to be a tree.</p>
<pre class="highlight literal-block">
box.space.*space-name*:create_index('<em>index-name</em>', { type = 'hash' })
</pre>
<p>The two ordinary index types are 'tree' which is the default, and 'hash'
which must be unique and which may be faster or smaller. The third type is
'bitset' which is not unique and which works best for combinations of binary
values. The fourth type is 'rtree' which is not unique and which works with arrays,
instead of 'string' or 'unsigned' values.</p>
</li>
</ol>
<p>The existence of indexes does not affect the syntax of data-change requests, but
does cause select requests to have more variety.</p>
<p>The simple select request which has been illustrated before is:</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select(</span><em><span class="pre">value</span></em><span class="pre">)</span></code>
</pre>
<p>By default, this looks for a single tuple
via the first index. Since the first index is always unique,
the maximum number of returned tuples will be: one.</p>
<p>These variations exist:</p>
<ol class="arabic">
<li><p class="first">The search can use comparisons other than equality.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select(value,</span> <span class="pre">{iterator</span> <span class="pre">=</span> <span class="pre">'GT'})</span></code>
</pre>
<p>The comparison operators are LT, LE, EQ, REQ, GE, GT for &quot;less than&quot;, &quot;less
than or equal&quot;, &quot;equal&quot;, &quot;reversed equal&quot;, &quot;greater than or equal&quot;, &quot;greater
than&quot; respectively.
Comparisons make sense if and only if the index type is 'tree'.</p>
<p>This type of search may return more than one tuple; if so, the tuples will be
in descending order by key when the comparison operator is LT or LE or REQ,
otherwise in ascending order.</p>
</li>
<li><p class="first">The search can use a secondary index.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">:select(value)</span></code>
</pre>
<p>For a primary-key search, it is optional to specify an index name. For a
secondary-key search, it is mandatory.</p>
</li>
<li><p class="first">The search may be for some or all key parts.</p>
<pre class="highlight literal-block">
-- Suppose an index has two parts
<code class="samp docutils literal"><span class="pre">tarantool&gt;</span> <span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">.parts</span></code>
---
- - type: unsigned
    fieldno: 1
  - type: string
    fieldno: 2
...
-- Suppose the space has three tuples
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select()</span></code>
---
- - [1, 'A']
  - [1, 'B']
  - [2, '']
...
</pre>
<p>The search can be for all fields, using a table for the value:</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select({1,</span> <span class="pre">'A'})</span></code>
</pre>
<p>or the search can be for one field, using a table or a scalar:</p>
<pre class="highlight literal-block">
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select(1)</span></code>
</pre>
<p>in the second case, the result will be two tuples: <code class="docutils literal"><span class="pre">{1,</span> <span class="pre">'A'}</span></code> and <code class="docutils literal"><span class="pre">{1,</span> <span class="pre">'B'}</span></code>.
It's even possible to specify zero fields, causing all three tuples to be
returned.</p>
</li>
</ol>
<p><strong>Examples:</strong></p>
<ul>
<li><p class="first">BITSET example:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bitset_example&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bitset&#39;</span><span class="p">,{</span><span class="n">unique</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">BITSET&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">bitset</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">iterator</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">BITS_ANY_SET&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>The result will be:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">7</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">4</span><span class="p p-Indicator">,</span> <span class="nv">3</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>because (7 AND 2) is not equal to 0, and (3 AND 2) is not equal to 0.</p>
<p>Searches on BITSET indexes can be for BITS_ANY_SET, BITS_ALL_SET,
BITS_ALL_NOT_SET, EQ, or ALL.</p>
</li>
<li><p class="first">RTREE example:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rtree_example&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rtree&#39;</span><span class="p">,{</span><span class="n">unique</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">RTREE&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">ARRAY&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">rtree</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GT&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>The result will be:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">9</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">]]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>because a rectangle whose corners are at coordinates 4,7,5,9 is entirely within
a rectangle whose corners are at coordinates 3,5,9,10.</p>
<p>Searches on RTREE indexes can be for GT, GE, LT, LE, OVERLAPS, or NEIGHBOR.</p>
</li>
</ul>
</div>
<div class="section" id="the-box-library">
<span id="index-box-library"></span><h3>3.1.9. The box library<a class="headerlink" href="#the-box-library" title="Permalink to this headline">¶</a></h3>
<p>As well as executing Lua chunks or defining their own functions, users can exploit
the Tarantool server's storage functionality with the <code class="docutils literal"><span class="pre">box</span> <span class="pre">library</span></code> and
its submodules.</p>
</div>
</div>
<div class="section" id="submodules-of-the-box-library">
<h2>3.2. Submodules of the box library<a class="headerlink" href="#submodules-of-the-box-library" title="Permalink to this headline">¶</a></h2>
<p>The contents of the <code class="docutils literal"><span class="pre">box</span></code> library can be inspected at runtime
with <code class="docutils literal"><span class="pre">box</span></code>, with no arguments. The submodules inside the box library are:
<code class="docutils literal"><span class="pre">box.schema</span></code>, <code class="docutils literal"><span class="pre">box.tuple</span></code>, <code class="docutils literal"><span class="pre">box.space</span></code>, <code class="docutils literal"><span class="pre">box.index</span></code>,
<code class="docutils literal"><span class="pre">box.cfg</span></code>, <code class="docutils literal"><span class="pre">box.info</span></code>, <code class="docutils literal"><span class="pre">box.slab</span></code>, <code class="docutils literal"><span class="pre">box.stat</span></code>.
Every submodule contains one or more Lua functions. A few submodules contain
members as well as functions. The functions allow data definition (create
alter drop), data manipulation (insert delete update upsert select replace), and
introspection (inspecting contents of spaces, accessing server configuration).</p>
<div class="table container">
<p><strong>Complexity Factors that may affect data
manipulation functions in the box library</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Index size</td>
<td>The number of index keys is the same as the number
of tuples in the data set. For a TREE index, if
there are more keys then the lookup time will be
greater, although of course the effect is not
linear. For a HASH index, if there are more keys
then there is more RAM use, but the number of
low-level steps tends to remain constant.</td>
</tr>
<tr class="row-even"><td>Index type</td>
<td>Typically a HASH index is faster than a TREE index
if the number of tuples in the tuple set is greater
than one.</td>
</tr>
<tr class="row-odd"><td>Number of indexes
accessed</td>
<td>Ordinarily only one index is accessed to retrieve
one tuple. But to update the tuple, there must be N
accesses if the tuple set has N different indexes.</td>
</tr>
<tr class="row-even"><td>Number of tuples
accessed</td>
<td>A few requests, for example select, can retrieve
multiple tuples. This factor is usually less
important than the others.</td>
</tr>
<tr class="row-odd"><td>WAL settings</td>
<td>The important setting for the write-ahead log is
<a class="reference internal" href="../configuration/index.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a>.
If the setting causes no writing or
delayed writing, this factor is unimportant. If the
setting causes every data-change request to wait
for writing to finish on a slow device, this factor
is more important than all the others.</td>
</tr>
</tbody>
</table>
</div>
<p>In the discussion of each data-manipulation function there will be a note about
which Complexity Factors might affect the function's resource usage.</p>
</div>
<div class="section" id="the-two-storage-engines-memtx-and-vinyl">
<span id="index-two-storage-engines"></span><h2>3.3. The two storage engines: memtx and vinyl<a class="headerlink" href="#the-two-storage-engines-memtx-and-vinyl" title="Permalink to this headline">¶</a></h2>
<p>A storage engine is a set of very-low-level routines which actually store and
retrieve tuple values. Tarantool offers a choice of two storage engines: memtx
(the in-memory storage engine) and vinyl (the on-disk storage engine).
To specify that the engine should be vinyl, add a clause: <code class="docutils literal"><span class="pre">engine</span> <span class="pre">=</span> <span class="pre">'vinyl'</span></code>.
The manual concentrates on memtx because it is the default and has been around
longer. But vinyl is a working key-value engine and will especially appeal to
users who like to see data go directly to disk, so that recovery time might be
shorter and database size might be larger. For architectural explanations and
benchmarks, see Appendix D: <a class="reference internal" href="../app/d_vinyl/index.html#index-vinyl"><span class="std std-ref">vinyl</span></a>.
On the other hand, vinyl lacks some functions and
options that are available with memtx. Where that is the case, the relevant
description will contain a note beginning with the words
&quot;Note re storage engine&quot;. The end of this chapter has coverage
for all <a class="reference internal" href="vinyl_diff.html#vinyl-diff"><span class="std std-ref">the differences between memtx and vinyl</span></a>.</p>
</div>
<div class="section" id="library-reference">
<h2>3.4. Library reference<a class="headerlink" href="#library-reference" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="box_schema.html">3.4.1. Submodule <cite>box.schema</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="box_space.html">3.4.2. Submodule <cite>box.space</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="box_index.html">3.4.3. Submodule <cite>box.index</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="box_session.html">3.4.4. Submodule <cite>box.session</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="box_tuple.html">3.4.5. Submodule <cite>box.tuple</cite></a></li>
<li class="toctree-l1"><a class="reference internal" href="box_introspection.html">3.4.6. Server introspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin.html">3.4.7. Administrative requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="atomic.html">3.4.8. Atomic execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="authentication.html">3.4.9. Access control</a></li>
<li class="toctree-l1"><a class="reference internal" href="triggers.html">3.4.10. Triggers</a></li>
<li class="toctree-l1"><a class="reference internal" href="limitations.html">3.4.11. Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="vinyl_diff.html">3.4.12. Differences between memtx and vinyl storage engines</a></li>
</ul>
</div>
</div>
</div>


          
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        // this.page.url = PAGE_URL;
        this.page.identifier = "book/box/index";
        this.language = "en"
    };
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//tarantooldb.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">
      comments powered by Disqus.
    </a>
  </noscript>

  
    
      <div class="b-page_over-tail">
    
    
      <div class="b-page_over-prev">
        <a href="../user_guide_getting_started.html"
           class="b-prev b-ellipsis"
           title="2. Getting started">2. Getting started</a>
      </div>
    
    <div class="b-page_over-lang">
      <ul class="b-page_over-lang-list">
        <li class="b-page_over-lang-item">
          <a href="../../_sources/book/box/index.txt"
             class="b-page_over-lang-url"> Source </a>
        </li>
      </ul>
    </div>
    
      <div class="b-page_over-next">
        <a href="box_schema.html"
           class="b-next b-ellipsis"
           title="3.4.1. Submodule &lt;cite&gt;box.schema&lt;/cite&gt;">3.4.1. Submodule <cite>box.schema</cite></a>
      </div>
    
    </div>
  
</div>
      </div>
    </div>
  
  <script>
  </script>

      </div>
    </div>

    <!-- FOOTER > -->
    <footer class="b-footer">
      <div class="b-footer-wrapper">
        <nav class="b-footer_menu">
          
  <ul class="b-menu">
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org" class="b-menu-item-url">Overview</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/doc/" class="b-menu-item-url p-active">Documentation</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/download.html" class="b-menu-item-url">Download</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/careers.html" class="b-menu-item-url">Careers</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
        
      </li>
    
  </ul>

          <div class="b-footer-other">
            <a href="http://stable.tarantool.org">1.5 web site and downloads</a>
          </div>
        </nav>
      </div>
    </footer>
  <!-- < FOOTER -->
  </body>
</html>


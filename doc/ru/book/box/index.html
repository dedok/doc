





<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3. Функционал СУБД</title>
    <link rel="icon" type="image/png" sizes="192x192"
          href="/theme/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32"
          href="/theme/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96"
          href="/theme/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16"
          href="/theme/favicon/favicon-16x16.png">
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:       '',
        VERSION:        '1.7.2',
        COLLAPSE_INDEX:  false,
        FILE_SUFFIX:    '.html',
        HAS_SOURCE:      true
      };
      
      
      var disqus_config = function () {
          // Replace PAGE_URL with your page's canonical URL variable
          // this.page.url = PAGE_URL;
          this.page.identifier = "book/box/index";
          this.language = "ru"
      };
    </script>
    <script id="dsq-count-scr" src="https://tarantooldb.disqus.com/count.js" async/></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="../../_static/stacktable.min.js"></script>
    <script type="text/javascript" src="../../_static/headers.js"></script>
    <script type="text/javascript" src="/js/menu.js"></script>
    <script type="text/javascript" src="/js/mobile_menu.js"></script>
    <link rel="stylesheet" href="/theme/font-awesome.min.css">
    <link rel="stylesheet" href="/theme/design.css">
    <link rel="stylesheet" href="/theme/pygmentize.css">
    <link rel="stylesheet" href="../../_static/sphinx_design.css">
     
    <!--[if lt IE 9]>
      <script src="/js/ie8.js"></script>
      <link rel="stylesheet" href="/theme/ie8.css" />
    <![endif]-->
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-22120502-1', 'auto');
  ga('send', 'pageview');
</script>

<!-- Rating@Mail.ru counter -->
<script type="text/javascript">
  var _tmr = _tmr || [];
  _tmr.push({id: "2284916", type: "pageView", start: (new Date()).getTime()});
  (function (d, w) {
    var ts = d.createElement("script"); ts.type = "text/javascript"; ts.async = true;
    ts.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//top-fwz1.mail.ru/js/code.js";
    var f = function () {var s = d.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ts, s);};
    if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); }
  })(document, window);
</script>
<noscript>
  <div style="position:absolute;left:-10000px;">
    <img src="//top-fwz1.mail.ru/counter?id=2284916;js=na" style="border:0;"
         height="1" width="1" alt="Рейтинг@Mail.ru" />
  </div>
</noscript>
<!-- //Rating@Mail.ru counter -->


  </head>
  
  <body class="p-cols_design b-doc-book/box/index">
  
    <div class="b-scrollview">
        <div class="b-wrapper">
        <!-- HEADER > -->
        
  <header class="b-header">
    <div class="b-header_menu_mobile">
      <div class="b-burger-button">
        <span></span>
      </div>
      <form role="search" class="b-header-search" action="../../search.html" method="get">
        <input name="q" type="search">
      </form>
    </div>
    <div class="b-menu_mobile">
      <div class="b-menu_mobile__wrapper">
        <nav class="b-header_menu">
          
  <ul class="b-menu">
    
      <li class="b-menu-item">
        <a href="/" class="b-menu-item-url">Overview</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/doc/" class="b-menu-item-url">Documentation</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/download.html" class="b-menu-item-url">Download</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

        </nav>
      </div>
      
    </div>
    <div class="b-header-wrapper">
      <nav class="b-header_menu">
        
  <ul class="b-menu">
    
      <li class="b-menu-item">
        <a href="/" class="b-menu-item-url">Overview</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/doc/" class="b-menu-item-url">Documentation</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/download.html" class="b-menu-item-url">Download</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

      </nav>
    </div>
  </header>

        <!-- < HEADER -->

        <div class="b-content b-clearbox">
            
  <section class="b-lightgray_block b-documentation_top b-clearbox p-documentation_in">
    <div class="b-block-wrapper">
      <h2
      
        class="b-section-title b-ellipsis toggle-navigation"
      
        title="3. Функционал СУБД">
          3. Функционал СУБД
      </h2>
  <div class="b-doc-language_selector">
    <ul class="b-doc-language_selector-list">
    
      <li class="b-doc-language_selector-item">
      
        <a href="
  
    ../../../book/box/index.html
  
"
           class="b-doc-language_selector-item-url"> En </a>
      
      </li>
    
      <li class="b-doc-language_selector-item">
      
        <a href="#" class="b-doc-language_selector-item-url p-active"> Ru </a>
      
      </li>
    
    </ul>
  </div>
</div>
  </section>
  
    <div class="b-cols_content b-clearbox">
      <div class="b-cols_content_left">
        <div class="b-menu-toc">
          
<form id="searchbox" role="search" class="search b-search" action="../../search.html" method="get">
  <input class="b-search-text" name="q" type="text"/ placeholder="Search the manual">
  <input class="b-search-but" type="submit" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../whats_new.html">Что нового?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../whats_new.html#what-s-new-in-tarantool-1-7">Что нового в Tarantool 1.7?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Общие сведения</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#an-application-server-together-with-a-database-manager">Сервер приложений + СУБД</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro.html#database-features">Возможности СУБД</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Практикум</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/lua_tutorials.html">1. Практические задания на Lua</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/lua_tutorials.html#insert-one-million-tuples-with-a-lua-stored-procedure">1.1. Вставка 1 млн кортежей с помощью хранимой процедуры на языке Lua</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#configure">1.1.1. Configure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#delimiter">1.1.2. Delimiter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#create-a-function-that-returns-a-string">1.1.3. Create a function that returns a string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#create-a-function-that-calls-another-function-and-sets-a-variable">1.1.4. Create a function that calls another function and sets a variable</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#modify-the-function-so-it-returns-a-one-letter-random-string">1.1.5. Modify the function so it returns a one-letter random string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#modify-the-function-so-it-returns-a-ten-letter-random-string">1.1.6. Modify the function so it returns a ten-letter random string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#make-a-tuple-out-of-a-number-and-a-string">1.1.7. Make a tuple out of a number and a string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#modify-main-function-to-insert-a-tuple-into-the-database">1.1.8. Modify main_function to insert a tuple into the database</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tutorials/lua_tutorials.html#modify-main-function-to-insert-a-million-tuples-into-the-database">1.1.9. Modify main_function to insert a million tuples into the database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/lua_tutorials.html#sum-a-json-field-for-all-tuples">1.2. Подсчет суммы по JSON-полям во всех кортежах</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/lua_tutorials.html#indexed-pattern-search">1.3. Индексированный поиск по шаблонам</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/c_tutorial.html">2. Практическое задание на C</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/c_tutorial.html#c-stored-procedures">2.1. Хранимые процедуры на языке C</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Руководство пользователя</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro.html">1. Предисловие</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../intro.html#how-to-read-the-documentation">1.1. Как пользоваться документацией</a></li>
<li class="toctree-l3"><a class="reference internal" href="../intro.html#getting-in-touch-with-the-tarantool-community">1.2. Как связаться с сообществом разработчиков Tarantool&#8217;а</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../user_guide_getting_started.html">2. Начало работы</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../user_guide_getting_started.html#downloading-and-installing-a-binary-package">2.1. Скачивание и установка бинарного пакета</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user_guide_getting_started.html#starting-tarantool-and-making-your-first-database">2.2. Первичный запуск Tarantool&#8217;а и создание базы данных</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user_guide_getting_started.html#connecting-remotely">2.3. Установка удаленного соединения</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3. Функционал СУБД</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-model">3.1. Модель данных</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#space">3.1.1. Пространство</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tuple-set">3.1.2. Набор кортежей</a></li>
<li class="toctree-l4"><a class="reference internal" href="#index">3.1.3. Индекс</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-types">3.1.4. Типы данных</a></li>
<li class="toctree-l4"><a class="reference internal" href="#operations">3.1.5. Операции</a></li>
<li class="toctree-l4"><a class="reference internal" href="#persistence">3.1.6. Persistence</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-manipulation">3.1.7. Манипулирование данными</a></li>
<li class="toctree-l4"><a class="reference internal" href="#index-operations">3.1.8. Операции с индексами</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#transaction-control">3.2. Контроль транзакций</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cooperative-multitasking-environment">3.2.1. Среда взаимной многозадачности</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#example">3.2.1.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#implicit-yields">3.2.2. Implicit yields</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#access-control">3.3. Ограничение доступа</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#passwords">3.3.1. Passwords</a></li>
<li class="toctree-l4"><a class="reference internal" href="#users-and-the-user-space">3.3.2. Users and the _user space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#privileges-and-the-priv-space">3.3.3. Privileges and the _priv space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functions-and-the-func-space">3.3.4. Functions and the _func space</a></li>
<li class="toctree-l4"><a class="reference internal" href="#box-session-and-security">3.3.5. box.session and security</a></li>
<li class="toctree-l4"><a class="reference internal" href="#roles">3.3.6. Roles</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#example-showing-a-role-within-a-role">3.3.6.1. Example showing a role within a role</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#triggers">3.4. Триггеры</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#connection-triggers">3.4.1. Connection triggers</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id3">3.4.1.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-triggers">3.4.2. Authentication triggers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lua-module.box.space">3.4.3. Replace triggers</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id4">3.4.3.1. Пример</a></li>
<li class="toctree-l5"><a class="reference internal" href="#another-example">3.4.3.2. Another example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#getting-a-list-of-triggers">3.4.4. Getting a list of triggers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#limitations">3.5. Ограничения</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vinyl-storage-engine">3.6. Дисковый движок vinyl</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#differences-between-memtx-and-vinyl-storage-engines">3.6.1. Различия между движками memtx и vinyl</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vinyl-features">3.6.2. Vinyl features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#under-the-hood">3.6.3. А что там &#8220;под капотом&#8221;?</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#inserting-the-first-200-000-keys">3.6.3.1. Inserting the first 200.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="#inserting-the-next-300-000-keys">3.6.3.2. Inserting the next 300.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="#inserting-the-next-200-000-keys">3.6.3.3. Inserting the next 200.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="#inserting-the-last-300-000-keys">3.6.3.4. Inserting the last 300.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="#reading-million-keys">3.6.3.5. Reading million keys</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../app_server.html">4. Сервер приложений</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../app_server.html#about-modules-rocks">4.1. Про модули/rocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app_server.html#installing-an-existing-module">4.2. Установка существующего модуля</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app_server.html#creating-a-new-lua-module-locally">4.3. Создание нового модуля на языке Lua</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app_server.html#creating-a-new-c-c-module-locally">4.4. Создание нового модуля на языке C/C++</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app_server.html#creating-a-mixed-lua-c-module-locally">4.5. Создание нового модуля на смеси языков Lua/C</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app_server.html#tips-for-special-situations">4.6. Примечания для особых случаев</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app_server.html#cookbook-recipes">4.7. Книга рецептов</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#hello-world-lua">4.7.1. hello_world.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#console-start-lua">4.7.2. console_start.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#fio-read-lua">4.7.3. fio_read.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#fio-write-lua">4.7.4. fio_write.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#ffi-printf-lua">4.7.5. ffi_printf.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#ffi-gettimeofday-lua">4.7.6. ffi_gettimeofday.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#ffi-zlib-lua">4.7.7. ffi_zlib.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#ffi-meta-lua">4.7.8. ffi_meta.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#print-arrays-lua">4.7.9. print_arrays.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#count-array-lua">4.7.10. count_array.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#count-array-with-nils-lua">4.7.11. count_array_with_nils.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#count-array-with-nulls-lua">4.7.12. count_array_with_nulls.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#count-map-lua">4.7.13. count_map.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#swap-lua">4.7.14. swap.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#uri-lua">4.7.15. uri.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#class-lua">4.7.16. class.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#garbage-lua">4.7.17. garbage.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#fiber-producer-and-consumer-lua">4.7.18. fiber_producer_and_consumer.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#socket-tcpconnect-lua">4.7.19. socket_tcpconnect.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#socket-tcp-echo-lua">4.7.20. socket_tcp_echo.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#getaddrinfo-lua">4.7.21. getaddrinfo.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#socket-udp-echo-lua">4.7.22. socket_udp_echo.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#http-get-lua">4.7.23. http_get.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#http-send-lua">4.7.24. http_send.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#http-server-lua">4.7.25. http_server.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../app_server.html#http-generate-html-lua">4.7.26. http_generate_html.lua</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../administration.html">5. Администрирование серверной части</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#using-tarantool-as-a-client">5.1. Использование tarantool в качестве клиента</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#conventions-used-in-this-section">5.1.1. Условные обозначения, используемые в этом разделе</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#options-when-starting-client-from-the-command-line">5.1.2. Параметры запуска клиента из командной строки</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#tokens-requests-and-special-key-combinations">5.1.3. Токены, запросы и специальные комбинации клавиш</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#requests">5.1.4. Запросы</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#utility-tarantoolctl">5.2. Утилита tarantoolctl</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#configuration-for-tarantoolctl">5.2.1. Конфигурирование tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#commands-for-tarantoolctl">5.2.2. Команды для tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#typical-code-snippets-for-tarantoolctl">5.2.3. Примеры кода для tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#a-detailed-example-for-tarantoolctl">5.2.4. Подробный пример для tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#an-example-for-tarantoolctl-connect">5.2.5. An example for tarantoolctl connect</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#administrative-ports">5.3. Служебные порты</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#administrative-requests">5.4. Служебные запросы</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#server-introspection">5.5. Просмотр состояния сервера</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#lua-module.box.cfg">5.5.1. Submodule <cite>box.cfg</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#lua-module.box.info">5.5.2. Submodule <cite>box.info</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#lua-module.box.slab">5.5.3. Submodule <cite>box.slab</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#submodule-box-stat">5.5.4. Submodule <cite>box.stat</cite></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#replication">5.6. Репликация</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#replication-architecture">5.6.1. Архитектура механизма репликации</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#setting-up-a-master">5.6.2. Setting up a master</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#setting-up-a-replica">5.6.3. Настройка сервера-реплики</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#recovering-from-a-degraded-state">5.6.4. Восстановление после сбоя</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#quick-startup-of-a-new-simple-two-server-cluster">5.6.5. Quick startup of a new simple two-server cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#monitoring-a-replica-s-actions">5.6.6. Мониторинг действий реплики</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#preventing-duplicate-actions">5.6.7. Предотвращение дублирующихся действий</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#master-master-replication">5.6.8. Репликация по схеме master-master</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#all-the-what-if-questions">5.6.9. Ответы на вопросы &#8220;Что если?&#8221;</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#hands-on-replication-tutorial">5.6.10. Практическое руководство по репликации</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#backups">5.7. Резервное копирование</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#cold-backup">5.7.1. Cold backup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#continuous-remote-backup">5.7.2. Continuous remote backup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#hot-backup">5.7.3. Hot backup</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#updates-upgrades">5.8. Обновление сервера и базы данных</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#updating-tarantool-in-production">5.8.1. Обновление Tarantool&#8217;а в условиях эксплуатации</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#upgrading-a-tarantool-database">5.8.2. Upgrading a Tarantool database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#server-signal-handling">5.9. Обработка сигналов от сервера</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#process-title">5.10. Название процесса</a></li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#system-specific-administration-notes">5.11. Заметки по администрированию для разных платформ</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#debian-gnu-linux-and-ubuntu">5.11.1. Debian GNU/Linux and Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#fedora-rhel-centos">5.11.2. Fedora, RHEL, CentOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#freebsd">5.11.3. FreeBSD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#mac-os-x">5.11.4. Mac OS X</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../administration.html#notes-for-systemd-users">5.12. Заметки для пользователей systemd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#instance-management">5.12.1. Управление экземплярами</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../administration.html#creating-instances">5.12.1.1. Создание экземпляров</a></li>
<li class="toctree-l5"><a class="reference internal" href="../administration.html#starting-instances">5.12.1.2. Запуск экземпляров</a></li>
<li class="toctree-l5"><a class="reference internal" href="../administration.html#monitoring-instances">5.12.1.3. Мониторинг экземпляров</a></li>
<li class="toctree-l5"><a class="reference internal" href="../administration.html#attaching-to-instances">5.12.1.4. Подсоединение к экземплярам</a></li>
<li class="toctree-l5"><a class="reference internal" href="../administration.html#checking-logs">5.12.1.5. Проверка журнала</a></li>
<li class="toctree-l5"><a class="reference internal" href="../administration.html#stopping-instances">5.12.1.6. Остановка экземпляров</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#daemon-supervision">5.12.2. Контроль за фоновыми программами</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#customizing-the-service-file">5.12.3. Правка настроек сервисного файла</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#debugging">5.12.4. Отладка</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#precautions">5.12.5. Особые указания</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#limitations">5.12.6. Ограничения</a></li>
<li class="toctree-l4"><a class="reference internal" href="../administration.html#sysvinit-systemd-conversion">5.12.7. sysvinit -&gt; systemd conversion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../connectors/index.html">6. Коннекторы</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#protocol">6.1. Протокол</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#packet-example">6.2. Пример пакета данных</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#setting-up-the-server-for-connector-examples">6.3. Настройка окружения для примеров работы с коннекторами</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#java">6.4. Java</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#go">6.5. Go</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#r">6.6. R</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#perl">6.7. Perl</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#php">6.8. PHP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#python">6.9. Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#c">6.10. C</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../connectors/index.html#example-1">6.10.1. Пример 1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../connectors/index.html#example-2">6.10.2. Пример 2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../connectors/index.html#interpreting-function-return-values">6.11. Интерпретация возвращаемых значений</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../faq.html">7. Вопросы и ответы</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Справочники</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/reference_lua/index.html">1. Справочник по встроенной библиотеке</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/box.html">1.1. Module <cite>box</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="box_schema.html">1.1.1. Вложенный модуль <cite>box.schema</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="box_space.html">1.1.2. Вложенный модуль <cite>box.space</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="box_space.html#example-use-box-space-functions-to-read-space-tuples">1.1.2.1. Example: use box.space functions to read _space tuples</a></li>
<li class="toctree-l5"><a class="reference internal" href="box_space.html#example-use-box-space-functions-to-organize-a-space-tuple">1.1.2.2. Example: use box.space functions to organize a _space tuple</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="box_index.html">1.1.3. Вложенный модуль <cite>box.index</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="box_index.html#example-showing-use-of-the-box-functions">1.1.3.1. Example showing use of the box functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="box_index.html#example-showing-a-user-defined-iterator">1.1.3.2. Example showing a user-defined iterator</a></li>
<li class="toctree-l5"><a class="reference internal" href="box_index.html#submodule-box-index-with-index-type-rtree-for-spatial-searches">1.1.3.3. Submodule <cite>box.index</cite> with index type = RTREE for spatial searches</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="box_session.html">1.1.4. Вложенный модуль <cite>box.session</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="box_session.html#example">1.1.4.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="box_tuple.html">1.1.5. Вложенный модуль <cite>box.tuple</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="box_tuple.html#example">1.1.5.1. Пример</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/clock.html">1.2. Module <cite>clock</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/console.html">1.3. Module <cite>console</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/crypto.html">1.4. Module <cite>crypto</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/crypto.html#incremental-methods-in-the-crypto-module">1.4.1. Incremental methods in the crypto module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/crypto.html#getting-the-same-results-from-digest-and-crypto-modules">1.4.2. Getting the same results from digest and crypto modules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/csv.html">1.5. Module <cite>csv</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/digest.html">1.6. Module <cite>digest</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/digest.html#incremental-methods-in-the-digest-module">1.6.1. Incremental methods in the digest module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/digest.html#example">1.6.2. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/box_error.html">1.7. Submodule <cite>box.error</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/fiber.html">1.8. Module <cite>fiber</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/fiber.html#example-of-fiber-use">1.8.1. Example Of Fiber Use</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/fiber_ipc.html">1.9. Submodule <cite>fiber-ipc</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/fiber_ipc.html#example">1.9.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/fiber_cond.html">1.10. Submodule <cite>fiber-cond</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/fiber_cond.html#example">1.10.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/fio.html">1.11. Module <cite>fio</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/fio.html#common-pathname-manipulations">1.11.1. Common pathname manipulations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/fio.html#common-file-manipulations">1.11.2. Common file manipulations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/fun.html">1.12. Module <cite>fun</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/json.html">1.13. Module <cite>json</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/json.html#configuration-settings">1.13.1. Configuration settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/log.html">1.14. Module <cite>log</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/log.html#example">1.14.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/msgpack.html">1.15. Module <cite>msgpack</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/msgpack.html#example">1.15.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/net_box.html">1.16. Module <cite>net.box</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/net_box.html#example-showing-use-of-most-of-the-net-box-methods">1.16.1. Example showing use of most of the net.box methods</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/box_once.html">1.17. Function <cite>box.once</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/pickle.html">1.18. Module <cite>pickle</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/socket.html">1.19. Module <cite>socket</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/socket.html#example">1.19.1. Example</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_lua/socket.html#use-of-a-tcp-socket-over-the-internet">1.19.1.1. Use of a TCP socket over the Internet</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_lua/socket.html#use-of-a-udp-socket-on-localhost">1.19.1.2. Use of a UDP socket on localhost</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_lua/socket.html#use-tcp-server-to-accept-file-contents-sent-with-socat">1.19.1.3. Use tcp_server to accept file contents sent with socat</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/strict.html">1.20. Module <cite>strict</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/tap.html">1.21. Module <cite>tap</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/tap.html#example">1.21.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/tarantool.html">1.22. Module <cite>tarantool</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/uuid.html">1.23. Module <cite>uuid</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/uuid.html#example">1.23.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/yaml.html">1.24. Module <cite>yaml</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_lua/yaml.html#example">1.24.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/other.html">1.25. Miscellaneous</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_lua/errcodes.html">1.26. Коды ошибок от базы данных</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/reference_rock/index.html">2. Справочник по сторонним библиотекам</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_rock/dbms.html">2.1. Модули SQL DBMS</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/dbms.html#mysql-example">2.1.1. MySQL Example</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#installation">2.1.1.1. Installation</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../reference/reference_rock/dbms.html#with-luarocks">2.1.1.1.1. With LuaRocks</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../reference/reference_rock/dbms.html#with-github">2.1.1.1.2. With GitHub</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#connecting">2.1.1.2. Connecting</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#how-to-ping">2.1.1.3. How to ping</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#executing-a-statement">2.1.1.4. Executing a statement</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#closing-connection">2.1.1.5. Closing connection</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#example">2.1.1.6. Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/dbms.html#postgresql-example">2.1.2. PostgreSQL Example</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id1">2.1.2.1. Installation</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id2">2.1.2.1.1. With LuaRocks</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id3">2.1.2.1.2. With GitHub</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id4">2.1.2.2. Connecting</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id5">2.1.2.3. How to ping</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id6">2.1.2.4. Executing a statement</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id7">2.1.2.5. Closing connection</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../reference/reference_rock/dbms.html#id8">2.1.2.6. Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_rock/expirationd.html">2.2. Module <cite>expirationd</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_rock/shard.html">2.3. Module <cite>shard</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/shard.html#example-shard-init-syntax-for-one-shard">2.3.1. Example: shard.init syntax for one shard</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/shard.html#example-shard-init-syntax-for-three-shards">2.3.2. Example: shard.init syntax for three shards</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/shard.html#example-shard-minimal-configuration">2.3.3. Example: Shard, Minimal Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/shard.html#example-shard-scaling-out">2.3.4. Example: Shard, Scaling Out</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/reference_rock/tdb.html">2.4. Module <cite>tdb</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/tdb.html#debugger-commands">2.4.1. Debugger Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/reference_rock/tdb.html#example-session">2.4.2. Example Session</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/configuration/index.html">3. Справочник по настройке</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/configuration/index.html#command-options">3.1. Опции комнандной строки</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/configuration/index.html#uri">3.2. Универсальный код ресурса (URI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/configuration/index.html#initialization-file">3.3. Файл инициализации</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/configuration/index.html#configuration-parameters">3.4. Параметры конфигурации</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../reference/configuration/index.html#basic-parameters">3.4.1. Basic parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/configuration/index.html#configuring-the-storage">3.4.2. Configuring the storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/configuration/index.html#snapshot-daemon">3.4.3. Snapshot daemon</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/configuration/index.html#binary-logging-and-snapshots">3.4.4. Binary logging and snapshots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/configuration/index.html#replication">3.4.5. Replication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/configuration/index.html#networking">3.4.6. Networking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../reference/configuration/index.html#logging">3.4.7. Logging</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guide/index.html">Руководство участника проекта</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dev_guide/reference_capi/index.html">1. Справочник по C API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/box.html">1.1. Module <cite>box</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/clock.html">1.2. Module <cite>clock</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/coio.html">1.3. Module <cite>coio</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/error.html">1.4. Module <cite>error</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/fiber.html">1.5. Module <cite>fiber</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/box_index.html">1.6. Module <cite>index</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/latch.html">1.7. Module <cite>latch</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/utils.html">1.8. Module <cite>lua/utils</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/say.html">1.9. Module <cite>say</cite> (logging)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/schema.html">1.10. Module <cite>schema</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/trivia.html">1.11. Module <cite>trivia/config</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/tuple.html">1.12. Module <cite>tuple</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/reference_capi/txn.html">1.13. Module <cite>txn</cite></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../dev_guide/internals_index.html">2. Детали реализации</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/internals_index.html#tarantool-s-binary-protocol">2.1. Бинарный протокол в Tarantool&#8217;е</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#notation-in-diagrams">2.1.1. Notation in diagrams</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#greeting-packet">2.1.2. Пакет-приветствие</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#unified-packet-structure">2.1.3. Unified packet structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#authentication">2.1.4. Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#requests">2.1.5. Requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#response-packet-structure">2.1.6. Response packet structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#replication-packet-structure">2.1.7. Replication packet structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/internals_index.html#xlog-snap">2.1.8. XLOG / SNAP</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/internals_index.html#data-persistence-and-the-wal-file-format">2.2. Персистентность данных и формат WAL-файла</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/internals_index.html#the-snapshot-file-format">2.3. Формат файла-снимка</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/internals_index.html#the-recovery-process">2.4. Процесс восстановления после сбоя</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/internals_index.html#server-startup-with-replication">2.5. Запуск сервера в режиме репликации</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../dev_guide/build_contribute_index.html">3. Сборка и участие в проекте</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/building_from_source.html">3.1. Сборка из исходных файлов</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/building_documentation.html">3.2. Сборка документации</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/release_management.html">3.3. Работа с релизами</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/release_management.html#how-to-make-a-minor-release">3.3.1. How to make a minor release</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../dev_guide/guidelines_index.html">4. Соглашения по разработке</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/developer_guidelines.html">4.1. Соглашения по разработке</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/developer_guidelines.html#how-to-work-on-a-bug">4.1.1. How to work on a bug</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html">4.2. Соглашения по документации</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#markup-issues">4.2.1. Markup issues</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#wrapping-text">4.2.1.1. Wrapping text</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#formatting-code-snippets">4.2.1.2. Formatting code snippets</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#using-separated-links">4.2.1.3. Using separated links</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#creating-labels-for-local-links">4.2.1.4. Creating labels for local links</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#making-comments">4.2.1.5. Making comments</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#language-and-style-issues">4.2.2. Language and style issues</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#us-vs-british-spelling">4.2.2.1. US vs British spelling</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#examples-and-templates">4.2.3. Examples and templates</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#module-and-function">4.2.3.1. Module and function</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/documentation_guidelines.html#module-class-and-method">4.2.3.2. Module, class and method</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/c_style_guide.html">4.3. Соглашения по разработке на языке C</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/c_style_guide.html#general-guidelines">4.3.1. General guidelines</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#commenting-style">4.3.1.1. Commenting style</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#header-files">4.3.1.2. Header files</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#allocating-memory">4.3.1.3. Allocating memory</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#other">4.3.1.4. Other</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/c_style_guide.html#linux-kernel-coding-style">4.3.2. Linux kernel coding style</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-1-indentation">4.3.2.1. Chapter 1: Indentation</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-2-breaking-long-lines-and-strings">4.3.2.2. Chapter 2: Breaking long lines and strings</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-3-placing-braces-and-spaces">4.3.2.3. Chapter 3: Placing Braces and Spaces</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-3-1-spaces">4.3.2.4. Chapter 3.1:  Spaces</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-4-naming">4.3.2.5. Chapter 4: Naming</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-5-typedefs">4.3.2.6. Chapter 5: Typedefs</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-6-functions">4.3.2.7. Chapter 6: Functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-7-centralized-exiting-of-functions">4.3.2.8. Chapter 7: Centralized exiting of functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-8-commenting">4.3.2.9. Chapter 8: Commenting</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-9-you-ve-made-a-mess-of-it">4.3.2.10. Chapter 9: You&#8217;ve made a mess of it</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-10-kconfig-configuration-files">4.3.2.11. Chapter 10: Kconfig configuration files</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-11-data-structures">4.3.2.12. Chapter 11: Data structures</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-12-macros-enums-and-rtl">4.3.2.13. Chapter 12: Macros, Enums and RTL</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-13-printing-kernel-messages">4.3.2.14. Chapter 13: Printing kernel messages</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-14-allocating-memory">4.3.2.15. Chapter 14: Allocating memory</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-15-the-inline-disease">4.3.2.16. Chapter 15: The inline disease</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-16-function-return-values-and-names">4.3.2.17. Chapter 16: Function return values and names</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-17-don-t-re-invent-the-kernel-macros">4.3.2.18. Chapter 17:  Don&#8217;t re-invent the kernel macros</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#chapter-18-editor-modelines-and-other-cruft">4.3.2.19. Chapter 18:  Editor modelines and other cruft</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/c_style_guide.html#appendix-i-references">4.3.2.20. Appendix I: References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../dev_guide/python_style_guide.html">4.4. Соглашения по разработке на языке Python</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#introduction">4.4.1. Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#a-foolish-consistency-is-the-hobgoblin-of-little-minds">4.4.2. A Foolish Consistency is the Hobgoblin of Little Minds</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#code-lay-out">4.4.3. Code lay-out</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#indentation">4.4.3.1. Indentation</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#tabs-or-spaces">4.4.3.2. Tabs or Spaces?</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#maximum-line-length">4.4.3.3. Maximum Line Length</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#blank-lines">4.4.3.4. Blank Lines</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#encodings-pep-263">4.4.3.5. Encodings (PEP 263)</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#imports">4.4.3.6. Imports</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#whitespace-in-expressions-and-statements">4.4.4. Whitespace in Expressions and Statements</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#pet-peeves">4.4.4.1. Pet Peeves</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#other-recommendations">4.4.4.2. Other Recommendations</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#comments">4.4.5. Comments</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#block-comments">4.4.5.1. Block Comments</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#inline-comments">4.4.5.2. Inline Comments</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#documentation-strings">4.4.5.3. Documentation Strings</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#version-bookkeeping">4.4.6. Version Bookkeeping</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#naming-conventions">4.4.7. Naming Conventions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#descriptive-naming-styles">4.4.7.1. Descriptive: Naming Styles</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../dev_guide/python_style_guide.html#prescriptive-naming-conventions">4.4.7.2. Prescriptive: Naming Conventions</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#names-to-avoid">4.4.7.2.1. Names to Avoid</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#package-and-module-names">4.4.7.2.2. Package and Module Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#class-names">4.4.7.2.3. Class Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#exception-names">4.4.7.2.4. Exception Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#global-variable-names">4.4.7.2.5. Global Variable Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#function-names">4.4.7.2.6. Function Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#function-and-method-arguments">4.4.7.2.7. Function and method arguments</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#method-names-and-instance-variables">4.4.7.2.8. Method Names and Instance Variables</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#constants">4.4.7.2.9. Constants</a></li>
<li class="toctree-l6"><a class="reference internal" href="../../dev_guide/python_style_guide.html#designing-for-inheritance">4.4.7.2.10. Designing for inheritance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#references">4.4.8. References</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dev_guide/python_style_guide.html#copyright">4.4.9. Copyright</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="b-cols_content_right">
        <div class="b-cols_content_right-slot">
  <div class="b-page_header">
    <ul class="b-path-list">
      <li class="b-path-list-item">
        <a href="../../index.html"
           class="b-path-list-item-url">
          Documentation
        </a>
      </li>
      
        <li class="b-path-list-item">
          <a href="../index.html"
             class="b-path-list-item-url b-ellipsis">
            Руководство пользователя
          </a>
        </li>
      
      
      <li class="b-path-list-item">
        <div title="3. Функционал СУБД" class="b-path_current b-ellipsis">
          3. Функционал СУБД
        </div>
      </li>
      
    </ul>
  </div>

  <div class="section" id="database">
<span id="database-chapter"></span><h1>3. Функционал СУБД<a class="headerlink" href="#database" title="Ссылка на этот заголовок">¶</a></h1>
<div class="section" id="data-model">
<h2>3.1. Модель данных<a class="headerlink" href="#data-model" title="Ссылка на этот заголовок">¶</a></h2>
<p>В этом разделе описывается то, как в Tarantool&#8217;е организовано хранение данных и какие операции с данным он поддерживает.</p>
<p>Если вы уже выполнили тестовое задание из раздела <a class="reference internal" href="../user_guide_getting_started.html#user-guide-getting-started-first-database"><span class="std std-ref">Первичный запуск Tarantool&#8217;а и создание базы данных</span></a> в предыдущей главе, то ваша база данных имеет следующий вид:</p>
<img alt="data_model.png" class="align-center" src="../../_images/data_model.png" />
<p>Here follow the descriptions of basic concepts.</p>
<div class="section" id="space">
<h3>3.1.1. Пространство<a class="headerlink" href="#space" title="Ссылка на этот заголовок">¶</a></h3>
<p><em>Пространство</em> с именем &#8216;tester&#8217; в нашем примере — это контейнер.</p>
<p>Когда Tarantool используется для хранения данных, то он создает по меньшей мере одно пространство (space). В общем же случае пространств может быть много. Каждое пространство имеет уникальное имя, заданное пользователем, а также уникальный числовой идентификатор, который тоже может быть задан пользователем, но обычно назначается автоматически самим Tarantool&#8217;ом. Пространство всегда содержит один набор кортежей и один или более индексов.</p>
</div>
<div class="section" id="tuple-set">
<h3>3.1.2. Набор кортежей<a class="headerlink" href="#tuple-set" title="Ссылка на этот заголовок">¶</a></h3>
<p><em>Набор кортежей</em> — в нашем примере он назван &#8216;tester&#8217; — это группа кортежей.</p>
<p>Каждое пространство всегда содержит один набор кортежей. Идентификатор набора кортежей совпадает с именем самого пространства, в нашем примере — <cite>tester</cite>.</p>
<p>Кортеж (tuple) выполняет ту же роль, что &#8220;строка&#8221; или &#8220;запись&#8221;, а компоненты кортежа (его &#8220;полЯ&#8221;) выполняют ту же роль, что &#8220;поле столбца, соответствующее данной строке&#8221; или &#8220;поле в записи&#8221; за тем исключением, что поля кортежа могут быть составными (например, они могут быть массивами или отображениями) и им не нужны имена. Поэтому нет необходимости предварительно определять набор кортежей при создании пространства, а каждый кортеж может иметь различное количество элементов. Кортежи хранятся в виде <a class="reference external" href="https://en.wikipedia.org/wiki/MessagePack">MsgPack</a>-массивов.</p>
<p>Кортеж может иметь любое количество полей, и это могут быть поля разных типов. Идентификатором поля является его номер. Поля нумеруются, начиная с 1. Так, например, “1” может использоваться в некоторых контекстах для обозначения первого поля кортежа.</p>
<p>Когда Tarantool возвращает значение кортежа, он берет строки в одинарные кавычки, отделяет поля с запятыми и заключает кортеж в квадратные скобки. Например, <code class="docutils literal"><span class="pre">[</span> <span class="pre">3,</span> <span class="pre">'length',</span> <span class="pre">93</span> <span class="pre">]</span></code>.</p>
</div>
<div class="section" id="index">
<span id="index-box-index"></span><h3>3.1.3. Индекс<a class="headerlink" href="#index" title="Ссылка на этот заголовок">¶</a></h3>
<p><em>Индекс</em> — в нашем примере он первичный — это совокупность значений ключей и указателей.</p>
<p>Чтобы набором кортежей было можно пользоваться, в пространстве необходим по крайней мере один индекс. Вообще же индексов в пространстве может быть много. Как и в случае с пространствами, пользователь может — и должен — указать имя индекса, а Tarantool подставляет уникальный числовой идентификатор (&#8220;идентификатор индекса&#8221;). В нашем примере всего один индекс с именем “primary”.</p>
<p>An index may be <em>multi-part</em>, that is, the user can declare that an index key
value is taken from two or more fields in the tuple, in any order. An index may
be <em>unique</em>, that is, the user can declare that it would be illegal to have the
same key value twice. An index may have <em>one of four types</em>: HASH which is
fast and is best for exact-equality searches with unique keys, TREE which allows
partial-key searching and ordered results, BITSET which can be good for searches
that contain &#8216;=&#8217; and multiple ANDed conditions, and RTREE for spatial coordinates.
The first index is called the “<em>primary key</em>” index and it must be unique; all
other indexes are called “secondary” indexes.</p>
<p>Индекс может содержать идентификаторы полей кортежа и типы данных для этих полей. Индексированные поля могут содержать данные следующих типов:</p>
<ul class="simple">
<li><p class="first"><code class="docutils literal"><span class="pre">unsigned</span></code> (беззнаковое целое число в диапазоне от 0 до 18,446,744,073,709,551,615)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">integer</span></code> (знаковое целое число в диапазоне от -9,223,372,036,854,775,808 до 9,223,372,036,854,775,807)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">number</span></code> (беззнаковое целое число, либо знаковое целое число, либо число с плавающей точкой)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">string</span></code> (строковое значение, т.е. любая последовательность октетов)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">scalar</span></code> (логическое значение, либо число, либо строковое значение)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">array</span></code> (последовательность чисел для <a class="reference internal" href="box_index.html#box-index-rtree"><span class="std std-ref">RTREE-индексов</span></a>)</p>
</li>
</ul>
<p>В рамках нашего примера рассмотрим следующий запрос:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hash&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
</pre></div>
</div>
<p>В результате у всех кортежей в пространстве <cite>tester</cite> должно быть поле с номером 1, содержащее беззнаковое целое число.</p>
<p>Space definitions and index definitions are stored permanently in system spaces.
It is possible to add, drop, or alter the definitions at runtime, with some
restrictions. See syntax details for defining spaces and indexes in
<a class="reference internal" href="../../reference/reference_lua/box.html#index-box-library"><span class="std std-ref">reference on Tarantool&#8217;s &#8220;box&#8221; module</span></a>.</p>
</div>
<div class="section" id="data-types">
<h3>3.1.4. Типы данных<a class="headerlink" href="#data-types" title="Ссылка на этот заголовок">¶</a></h3>
<p>Tarantool работает с числами (numbers), строками (strings), логическими значениями (booleans), таблицами (tables) и пользовательскими типами данных (userdata).</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="18%" />
<col width="41%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Общий тип</p>
</th>
<th class="head"><p class="first last">Особый тип</p>
</th>
<th class="head"><p class="first last">Результат Lua type()</p>
</th>
<th class="head"><p class="first last">Пример</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>scalar</td>
<td>number</td>
<td>&#8220;<a class="reference external" href="http://www.lua.org/pil/2.3.html">number</a>&#8220;</td>
<td>12345</td>
</tr>
<tr class="row-odd"><td>scalar</td>
<td>string</td>
<td>&#8220;<a class="reference external" href="http://www.lua.org/pil/2.4.html">string</a>&#8220;</td>
<td>&#8216;A B C&#8217;</td>
</tr>
<tr class="row-even"><td>scalar</td>
<td>boolean</td>
<td>&#8220;<a class="reference external" href="http://www.lua.org/pil/2.2.html">boolean</a>&#8220;</td>
<td>true</td>
</tr>
<tr class="row-odd"><td>scalar</td>
<td>nil</td>
<td>&#8220;<a class="reference external" href="http://www.lua.org/pil/2.1.html">nil</a>&#8220;</td>
<td>nil</td>
</tr>
<tr class="row-even"><td>compound</td>
<td>Lua table</td>
<td>&#8220;<a class="reference external" href="http://www.lua.org/pil/2.5.html">table</a>&#8220;</td>
<td>table: 0x410f8b10</td>
</tr>
<tr class="row-odd"><td>compound</td>
<td>tuple</td>
<td>&#8220;<a class="reference external" href="http://www.lua.org/pil/28.1.html">Userdata</a>&#8220;</td>
<td>12345: {&#8216;A B C&#8217;}</td>
</tr>
</tbody>
</table>
<p>In Lua, a <em>number</em> is double-precision floating-point, but Tarantool allows both
integer and floating-point values. Tarantool will try to store a number as
floating-point if the value contains a decimal point or is very large (greater
than 100 billion = 1e14), otherwise Tarantool will store it as an integer. To
ensure that even very large numbers will be treated as integers, use the
<a class="reference internal" href="../../reference/reference_lua/other.html#other-tonumber64"><span class="std std-ref">tonumber64</span></a> function, or the <code class="docutils literal"><span class="pre">LL</span></code> (Long Long) suffix,
or the <code class="docutils literal"><span class="pre">ULL</span></code> (Unsigned Long Long) suffix. Here are examples of numbers using
regular notation, exponential notation, the ULL suffix, and the tonumber64
function: <code class="docutils literal"><span class="pre">-55</span></code>, <code class="docutils literal"><span class="pre">-2.7e+20</span></code>, <code class="docutils literal"><span class="pre">100000000000000ULL</span></code>,
<code class="docutils literal"><span class="pre">tonumber64('18446744073709551615')</span></code>.</p>
<p>For database storage, Tarantool uses MsgPack rules. Storage is variable-length,
so the smallest number requires only one byte but the largest number requires
nine bytes. When a field has an &#8216;unsigned&#8217; index, all values must be unsigned integers
between 0 and 18,446,744,073,709,551,615.</p>
<p>Тип <em>string</em> (строка) — это последовательность байтов, имеющая переменную длину. Как правило, строки представлены в виде алфавитно-числовых символы, заключенных в одинарные кавычки.</p>
<p>Тип <em>boolean</em> (логический) может иметь только значения <code class="docutils literal"><span class="pre">true</span></code> или <code class="docutils literal"><span class="pre">false</span></code>.</p>
<p>Тип <em>nil</em> (нулевой) может иметь только одно значение, также называемое <em>nil</em>, но часто отображаемое как <em>null</em>. Нулевое значение можно сравнивать со значениями любых типов с помощью операторов == (равен) или ~= (не равен), но никакие другие операции для нулевых значений не доступны. Нулевые значения также нельзя использовать в Lua-таблицах; вместо нулевого значения в таком случае можно указать <a class="reference internal" href="../../reference/reference_lua/yaml.html#yaml-null"><span class="std std-ref">yaml.NULL</span></a>, либо <a class="reference internal" href="../../reference/reference_lua/json.html#json-null"><span class="std std-ref">json.NULL</span></a>, либо <a class="reference internal" href="../../reference/reference_lua/msgpack.html#msgpack-null"><span class="std std-ref">msgpack.NULL</span></a>.</p>
<p>Тип <em>tuple</em> возвращается в формате YAML, например <code class="docutils literal"><span class="pre">-</span> <span class="pre">[120,</span> <span class="pre">'a',</span> <span class="pre">'b',</span> <span class="pre">'c']</span></code>. Некоторые функции могут возвращать таблицы с несколькими кортежами. Скалярная величина может быть конвертирована в кортеж с 1 полем. Lua-таблица может содержать все типы полей, допустимые для кортежей, кроме нулевого типа (nil).</p>
<p>Некоторые из этих типов данных подходят для <a class="reference internal" href="box_space.html#details-about-index-field-types"><span class="std std-ref">индексируемых полей</span></a>.</p>
<p>См. также примеры кортежей в разделе про модуль <a class="reference internal" href="box_tuple.html#box-tuple"><span class="std std-ref">box.tuple</span></a>.</p>
</div>
<div class="section" id="operations">
<h3>3.1.5. Операции<a class="headerlink" href="#operations" title="Ссылка на этот заголовок">¶</a></h3>
<p>Основные операции — это пять операций для изменения данных (INSERT, UPDATE, UPSERT, DELETE, REPLACE) и одна операция для возвращения данных (SELECT). Также в Tarantool&#8217;е поддерживаются второстепенные операции типа PING, которые можно использовать только в рамках бинарного протокола. Кроме того, в Tarantool&#8217;е есть операции для <a class="reference internal" href="box_index.html#box-index-index-pairs"><span class="std std-ref">индекс-итераторов</span></a>, которые можно использовать только в коде на языке Lua. (Индекс-итераторы нужны для обхода индексов от одного ключа к другому и дают возможность пользоваться преимуществами разных типов индексов, например вычислять значение выражений логического типа при обходе BITSET-индексов или двигаться в порядке убывания значений при обходе TREE-индексов.)</p>
<p>Шесть примеров основных операций:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- Добавляем новый кортеж в набор кортежей с именем tester.</span>
<span class="go">-- Первое поле, field[1], будет равно 999 (тип = unsigned).</span>
<span class="go">-- Второе поле, field[2], будет равно &#39;Taranto&#39; (тип = string).</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Taranto&#39;</span><span class="p">}</span>

<span class="go">-- Обновляем кортеж, меняем значение поля field[2].</span>
<span class="go">-- Условие &quot;{999}&quot;, содержащее значение ключа, которое нужно</span>
<span class="go">-- искать в первичном индексе, построенном по первому полю</span>
<span class="go">-- кортежа, является обязательным, поскольку запросам update()</span>
<span class="go">-- всегда требуется условие, определяющее значение первичного</span>
<span class="go">-- ключа, в данном случае field[1].</span>
<span class="go">-- Условие &quot;{{&#39;=&#39;, 2, &#39;Tarantino&#39;}}&quot; определяет, что полю field[2] нужно</span>
<span class="go">-- присвоить новое значение.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantino&#39;</span><span class="p">}})</span>

<span class="go">-- Выполняем операцию upsert() для кортежа и снова меняем</span>
<span class="go">-- значение поля field[2].</span>
<span class="go">-- Синтаксис запроса upsert() аналогичен синтаксису update(),</span>
<span class="go">-- но возвращаемые значения у этих запросов разные.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">upsert</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantism&#39;</span><span class="p">}})</span>

<span class="go">-- Производим замену кортежа с помощью replace(), добавляем новое поле.</span>
<span class="go">-- Это можно сделать и с помощью запроса update(),</span>
<span class="go">-- но такой вариант часто оказывается более сложным.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantella&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantula&#39;</span><span class="p">}</span>

<span class="go">-- Возвращаем значение кортежа.</span>
<span class="go">-- Условие &quot;{999}&quot; все еще обязательно, хотя оно и не должно</span>
<span class="go">-- содержать значение первичного ключа.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>

<span class="go">-- Удаляем кортеж.</span>
<span class="go">-- Условие, определяющее значение первичного ключа,</span>
<span class="go">-- снова является обязательным.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>
</pre></div>
</div>
<p>Как Tarantool выполняет основные операции? Давайте рассмотрим это на следующем примере:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">3</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">size&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">}})</span>
</pre></div>
</div>
<p>Это аналогично следующему выражению на языке SQL:</p>
<div class="highlight-SQL"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">tester</span> <span class="k">SET</span> <span class="ss">&quot;field[2]&quot;</span> <span class="o">=</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="ss">&quot;field[3]&quot;</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">WHERE</span> <span class="ss">&quot;field[[1]&quot;</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<ol class="arabic simple">
<li>If this is happening on a remote client, then the client parses the statement
and changes it to a binary-protocol instruction which has already been
checked, and which the server can understand without needing to parse
everything again. The client ships a packet to the server.</li>
<li>The server&#8217;s “transaction processor” thread uses the primary-key index on
field[1] to find the location of the tuple in memory. It determines that the
tuple can be updated (not much can go wrong when you&#8217;re merely changing an
unindexed field value to something shorter).</li>
<li>The transaction processor thread sends a message to the write-ahead logging
(WAL) thread.</li>
</ol>
<p>At this point, a <em>yield</em> takes place. To know the significance of that &#8211; and
it&#8217;s quite significant &#8211; you have to know a few facts and a few new words.</p>
<div class="fact admonition">
<p class="first admonition-title">ФАКТ #1:</p>
<p class="last">There is only one transaction processor thread. Some people are used to the
idea that there can be multiple threads operating on the database, with
(say) thread #1 reading row #x while thread #2 writes row #y. With Tarantool
no such thing ever happens. Only the transaction processor thread can access
the database, and there is only one transaction processor thread for each
instance of the server.</p>
</div>
<div class="fact admonition">
<p class="first admonition-title">ФАКТ #2:</p>
<p class="last">The transaction processor thread can handle many <em>fibers</em>. A fiber is a set
of computer instructions that may contain &#8220;yield&#8221; signals. The transaction
processor thread will execute all computer instructions until a yield, then
switch to execute the instructions of a different fiber. Thus (say) the
thread reads row #x for the sake of fiber #1, then writes row #y for the sake
of fiber #2.</p>
</div>
<div class="fact admonition" id="index-yields-must-happen">
<p class="first admonition-title">ФАКТ #3:</p>
<p class="last">Yields must happen, otherwise the transaction processor thread would stick
permanently on the same fiber. There are <a class="reference internal" href="#atomic-the-implicit-yield-rules"><span class="std std-ref">implicit yields</span></a>:
every data-change operation or network-access causes an implicit yield, and
every statement that goes through the tarantool client causes an implicit
yield. And there are explicit yields: in a Lua function one can and should
add “yield” statements to prevent hogging. This is called <em>cooperative multitasking</em>.</p>
</div>
<p>Поскольку все операции, связанные с изменением данных, заканчиваются неявной передачей управления и неявным коммитом, и поскольку каждая такая операция может затрагивать не более одного кортежа, то не возникает нужды в блокировках. Для примера рассмотрим следующую Lua-функцию, которая осуществляет три операции в Tarantool&#8217;е:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>             <span class="c1">-- не происходит ни передачи управления, ни коммита</span>
<span class="n">s</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="o">...</span><span class="p">},{{</span><span class="o">...</span><span class="p">}})</span>   <span class="c1">-- происходит и передача управления, и коммит</span>
<span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>             <span class="c1">-- не происходит ни передачи управления, ни коммита</span>
</pre></div>
</div>
<p>Последовательность операций “SELECT + UPDATE” является атомарной транзакцией: функция сохраняет базу данных в согласованном виде, пока не отработает UPDATE. А в случае “UPDATE + SELECT” согласованности нет, поскольку после операции UPDATE поток обработки транзакций может переключится на другой файбер и удалить тот кортеж, что был обновлен в рамках предыдущей операции UPDATE.</p>
<p>Примечание про движок: в движке vinyl передача управления происходит по-другому, см. раздел про <a class="reference internal" href="#vinyl-diff"><span class="std std-ref">различия между движками memtx и vinyl</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p>Примечание про составные транзакции:</p>
<p class="last">There is a way to delay yields. Read about execution atomicity
in section <a class="reference internal" href="#transaction-control"><span class="std std-ref">Transaction control</span></a>.</p>
</div>
<p>Посколько блокировки не используются, а запись на диск производится только при работе с WAL-файлом, то транзакции в Tarantool&#8217;е обычно совершаются быстро. Кроме того, если мы имеем дело с мощным многоядерным процессором, то Tarantool-сервер может задействовать для работы не все потоки такого процессора, и продвинутые пользователи могут безболезненно запускать второй Tarantool-сервер на том же процессоре.</p>
<p>См. также примеры с запросами в регрессионных тестах для Tarantool&#8217;а (<a class="reference external" href="https://github.com/tarantool/tarantool/tree/1.7/test/box">https://github.com/tarantool/tarantool/tree/1.7/test/box</a>). Полное описание грамматики поддерживаемых в Tarantool&#8217;е функций для манипулирования данными см. далее в этой главе.</p>
<p>Не все операции в Tarantool&#8217;е можно выразить с помощью функций по манипулированию данными или с помощью языка Lua. Чтобы получить доступ ко всем возможностями манипулирования данными, вам понадобится <a class="reference internal" href="../connectors/index.html#index-box-connectors"><span class="std std-ref">коннектор для Perl, PHP, Python или другого языка программирования</span></a>. Бинарный клиент-серверный протокол для коннекторов является открытым. Документация по нему доступна в виде аннотированных <a class="reference internal" href="../../dev_guide/internals_index.html#box-protocol-iproto-protocol"><span class="std std-ref">BNF-диаграмм</span></a>.</p>
</div>
<div class="section" id="persistence">
<h3>3.1.6. Persistence<a class="headerlink" href="#persistence" title="Ссылка на этот заголовок">¶</a></h3>
<p>Tarantool сохраняет данные и информацию об изменениях в нескольких WAL-файлах (write-ahead log). Записью в WAL занимается отдельный поток. Он ловит все запросы, которые могут привести к изменению данных в базе, например <code class="docutils literal"><span class="pre">box.schema.create</span></code> или <code class="docutils literal"><span class="pre">box.space.insert</span></code>. Как правило, запись о запросе, включая служебные поля и флаги, делается в WAL-файл немедленно. Это обеспечивает сохранность данных, поскольку, даже если данные из памяти утеряны вследствие перебоя в электроснабжении, Tarantool восстановит их автоматически при следующем старте: он загрузит данные из WAL-файлов, а затем применит все записанные в WAL-файлах запросы (это называется &#8220;процесс восстановления&#8221;). Пользователи могут менять частоту записи или вовсе отключать запись в WAL с помощью параметра <a class="reference internal" href="../../reference/configuration/index.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a>.</p>
<p>Tarantool также сохраняет ряд файлов со статическими снимками данных (snapshots). Файл со снимком — это дисковая копия всех данных в базе на какой-то момент. Вместо того, чтобы зачитывать все WAL-файлы, появившиеся с момента создания базы, Tarantool в процессе восстановления может загрузить самый свежий снимок и затем зачитать только те WAL-файлы, которые были сделаны с момента сохранения снимка. Снимки могут делаться автоматически, или же пользователи могут создавать их сами в любой момент с помощью запроса <a class="reference internal" href="../administration.html#admin-snapshot"><span class="std std-ref">box.snapshot()</span></a>.</p>
<p>Details about the WAL writer and the recovery process are in the
<a class="reference internal" href="../../dev_guide/internals_index.html#id1"><span class="std std-ref">Internals</span></a> section.</p>
</div>
<div class="section" id="data-manipulation">
<h3>3.1.7. Манипулирование данными<a class="headerlink" href="#data-manipulation" title="Ссылка на этот заголовок">¶</a></h3>
<p>Основные запросы для <em>манипулирования данными</em> — это <code class="docutils literal"><span class="pre">insert</span></code>, <code class="docutils literal"><span class="pre">replace</span></code>, <code class="docutils literal"><span class="pre">update</span></code>, <code class="docutils literal"><span class="pre">upsert</span></code>, <code class="docutils literal"><span class="pre">delete</span></code>, <code class="docutils literal"><span class="pre">select</span></code>. Все они реализованы в библиотеке <code class="docutils literal"><span class="pre">box</span></code>. Многие из этих запросов могут возвращать данные. Как правило, и вводимые, и возвращаемые значения являются Lua-таблицами.</p>
<p>Lua-синтаксис в данных функциях может различаться. Далее приводятся варианты таких различий на примере SELECT-запросов. Аналогичные правила существуют и для остальных функций. В каждом из приведенных примеров выполняются следующие действия: производится выборка по набору кортежей из пространства с именем &#8216;tester&#8217;, где значение поля, которое соответствует ключу в первичном индексе, равно 1. Также во всех примерах мы подразумеваем, что числовой идентификатор пространства &#8216;tester&#8217; равен 512, но это верно только для нашей тестовой базы.</p>
<p id="index-object-reference">Во-первых, есть пять <em>способов ссылки на объект</em>:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- #1 имя_модуля . имя_вложенного_модуля . имя_объекта</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #2 вместо имени объекта указываем литерал в квадратных скобках</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #3 вместо имени объекта указываем числовой идентификатор в квадратных скобках</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="mi">512</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #4 вместо литерала, обозначающего имя объекта, указываем переменную</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">variable</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #5 указываем переменную вместо ссылки на весь объект</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>Для примеров в остальной части документации мы будем, как правило, использовать вариант синтаксиса #1, например &#8220;<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">tester</span></em><span class="pre">:</span></code>&#8221;. Но вы можете с тем же успехом пользоваться любым из пяти описанных выше вариантов.</p>
<p>Также мы в дальнейшем будем использовать синтаксис типа  &#8220;<code class="code docutils literal"><span class="pre">space_object:</span></code>&#8221; для ссылки на пространства (как в приведенных выше примерах) и &#8220;<code class="code docutils literal"><span class="pre">index_object:</span></code>&#8221; для ссылки на индексы (например, <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">tester</span></em><span class="pre">.index.</span><em><span class="pre">primary</span></em><span class="pre">:</span></code>).</p>
<p>Во-вторых, есть семь <em>способов задания параметров</em>:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- #1</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #2</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">})</span>
<span class="go">-- #3</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">-- #4</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="go">-- #5</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">},{</span><span class="n">iterator</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">EQ&#39;</span><span class="p">})</span>
<span class="go">-- #6</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="n">variable</span><span class="p">}</span>
<span class="go">-- #7</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
</pre></div>
</div>
<p>Значение первичного ключа заключается в фигурные скобки. Если же этот первичный ключ является составным, то и значение будет составным, например <code class="docutils literal"><span class="pre">...select{1,2,3}</span></code>. Фигурные скобки в свою очередь могут заключаться в круглые скобки — например, <code class="docutils literal"><span class="pre">...select({...})</span></code>. Это опциональный вариант синтаксиса, и он необходим только в том случае, если нужно передать что-то помимо первичного ключа, как в примере #5. Вместо значений-литералов — например, 1 (скалярное значение) или {1} (Lua-таблица) — можно использовать имена переменных, как в примерах #6 и #7. Хотя в некоторых случаях фигурные скобки можно опускать, мы рекомендуем всегда их использовать. Так вы явно обозначите, что значение имеет тип &#8220;Lua-таблица&#8221;. В примерах и описаниях в документации мы везде используем фигурные скобки, например &#8220;{1}&#8221;.  Но как и в случае со ссылками на объект, вы можете пользоваться любым допустимым вариантом синтаксиса.</p>
<p>Все функции для манипулирования данными оперируют наборами кортежей. Однако, поскольку первичные ключи всегда уникальны, количество кортежей в таком наборе всегда равно 0 или 1. Единственным исключением является функция <code class="docutils literal"><span class="pre">box.space...select</span></code>, которая может брать на вход как первичный, так и вторичный ключ.</p>
<div class="table container">
<p><strong>Complexity factors that may affect data-manipulation functions</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><p class="first last">Размер индекса</p>
</td>
<td><p class="first last">Количество ключей в индексе равно количеству кортежей в наборе данных. В случае с TREE-индексом: с ростом количества ключей увеличивается время поиска, хотя зависимость здесь, конечно же, не линейная. В случае с HASH-индексом: с ростом количества ключей увеличивается объем используемой памяти, но количество низкоуровневых шагов остается примерно тем же.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last">Тип индекса</p>
</td>
<td><p class="first last">Как правило, поиск по HASH-индексу работает быстрее, чем по TREE-индексу, если в наборе есть более одного кортежа.</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last">Количество обращений к индексам</p>
</td>
<td><p class="first last">Обычно для выборки значений одного кортежа используется только один индекс. Но при обновлении значений в кортеже требуется N обращений, если у набора кортежей есть N индексов.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last">Количество обращений к кортежам</p>
</td>
<td><p class="first last">Некоторые запросы, например SELECT, могут возвращать несколько кортежей. Как правило, это наименее важный фактор из всех.</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last">Настройки WAL</p>
</td>
<td><p class="first last">Важным параметром для записи в WAL является <a class="reference internal" href="../../reference/configuration/index.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a>. Если запись в WAL отключена или задана запись с задержкой, но этот фактор не так важен. Если же запись в WAL производится при каждом запросе на изменение данных, то при каждом таком запросе приходится ждать, пока отработает обращение к более медленному диску, и данный фактор становится важнее всех остальных.</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>In the discussion of each data-manipulation function, there will be a note about
which complexity factors might affect the function&#8217;s resource usage.</p>
</div>
<div class="section" id="index-operations">
<h3>3.1.8. Операции с индексами<a class="headerlink" href="#index-operations" title="Ссылка на этот заголовок">¶</a></h3>
<p>Операции с индексами производятся автоматически. Если запрос по манипулированию данными меняет данные в кортеже, то меняются и ключи в индексе для данного кортежа. Поэтому пользователю нужно знать только как и зачем задавать индексы.</p>
<p>Простая операция для создания индекса, которую мы рассматривали ранее, имела следующий вид:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span>:samp:`box.space.{имя-пространства}:create_index(&#39;{имя-индекса}&#39;)`
</pre></div>
</div>
<p>По умолчанию, при этом создается TREE-индекс по первому полю (обычно его называют &#8220;Field#1&#8221;) для всех кортежей в пространстве. Предполагается, что индексируемое поле является числовым.</p>
<p>Также возможны следующие варианты:</p>
<ol class="arabic">
<li><p class="first">Индексируемое поле может быть строкой, а не числом.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:create_index('</span><em><span class="pre">index-name</span></em><span class="pre">',</span> <span class="pre">{parts</span> <span class="pre">=</span> <span class="pre">{1,</span> <span class="pre">'string'}})</span></code>
</pre>
<p>Обычный индекс, как правило, строится по полям одного из двух типов: &#8216;NUM&#8217; = числовой (numeric) = любое неотрицательное целое число, либо &#8216;STR&#8217; = строка (string) = любая последовательность байтов. Числа в индексе упорядочены по числовой прямой (например, число 2345 больше, чем число 500), а строки — по коду первого байта, затем по коду второго, третьего и т.д. (и теперь строка &#8216;2345&#8217; будет меньше, чем строка &#8216;500&#8217;).</p>
<p>Подробнее о других типах индексов см. в описании функции <a class="reference internal" href="box_space.html#box-space-create-index"><span class="std std-ref">create_index</span></a>.</p>
</li>
<li><p class="first">Индекс может строиться по нескольким полям.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:create_index('</span><em><span class="pre">index-name</span></em><span class="pre">',</span> <span class="pre">{</span>
&nbsp;&nbsp;&nbsp; <span class="pre">parts</span> <span class="pre">=</span> <span class="pre">{3,</span> <span class="pre">'unsigned',</span> <span class="pre">2,</span> <span class="pre">'string'}</span>
<span class="pre">})</span></code>
</pre>
<p>В обычном индексе может быть максимум 255 частей. Каждая часть характеризуется номером поля и его типом.</p>
</li>
<li><p class="first">Индекс может быть неуникальным.</p>
<pre class="highlight literal-block">
box.space.*space-name*:create_index('<em>index-name</em>', { unique = false })
</pre>
<p>Первичный индекс для кортежа должен строиться по уникальным значениям полей, но остальные (вторичные) индексы могут строиться по неуникальным значениям.</p>
</li>
<li><p class="first">Индекс может представлять собой не только дерево.</p>
<pre class="highlight literal-block">
box.space.*space-name*:create_index('<em>index-name</em>', { type = 'hash' })
</pre>
<p>The two ordinary index types are &#8216;tree&#8217; which is the default, and &#8216;hash&#8217;
which must be unique and which may be faster. The third type is
&#8216;bitset&#8217; which is not unique and which works best for combinations of binary
values. The fourth type is &#8216;rtree&#8217; which is not unique and which works with arrays,
instead of &#8216;string&#8217; or &#8216;unsigned&#8217; values.</p>
</li>
</ol>
<p>Наличие индексов никак не влияет на синтаксис запросов на изменение данных. А вот SELECT-запросы, благодаря индексам, становятся более разнообразными.</p>
<p>Вот простой SELECT-запрос, который мы рассматривали ранее:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span>:extsamp:`box.space.{*{имя-пространства}*}:select({*{значение}*})`
</pre></div>
</div>
<p>По умолчанию, такой запрос ищет нужный кортеж по значению в первом (первичном) индексе. Поскольку первичный индекс всегда уникален, то данный запрос вернет не более одного кортежа.</p>
<p>Также возможны следующие варианты:</p>
<ol class="arabic">
<li><p class="first">Помимо условия равенства, при поиске могут использоваться и другие условия сравнения.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select(value,</span> <span class="pre">{iterator</span> <span class="pre">=</span> <span class="pre">'GT'})</span></code>
</pre>
<p>Можно использовать следующие операторы сравнения: LT (меньше), LE (меньше или равно), EQ (равно), REQ (неравно), GE (больше или равно), GT (больше). Сравнения имеют смысл только для индексов типа &#8216;tree&#8217;.</p>
<p>Этот вариант поиска может вернуть более одного кортежа. В таком случае кортежи будут отсортированы в порядке убывания по ключу (если использовался оператор LT, LE или REQ), либо в порядке возрастания (во всех остальных случаях).</p>
</li>
<li><p class="first">Поиск может производиться по вторичному индексу.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">:select(value)</span></code>
</pre>
<p>При поиске по первичному индексу имя индекса можно не указывать. При поиске же по вторичному индексу имя индекса указывать необходимо.</p>
</li>
<li><p class="first">Поиск может производиться как по всему ключу, так и по его частям.</p>
<pre class="highlight literal-block">
-- Suppose an index has two parts
<code class="samp docutils literal"><span class="pre">tarantool&gt;</span> <span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">.parts</span></code>
---
- - type: unsigned
    fieldno: 1
  - type: string
    fieldno: 2
...
-- Suppose the space has three tuples
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select()</span></code>
---
- - [1, 'A']
  - [1, 'B']
  - [2, '']
...
</pre>
<p>Поиск может производиться по всем полям (в этом случае используется таблица значений):</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select({1,</span> <span class="pre">'A'})</span></code>
</pre>
<p>Либо же по одному полю (в этом случае используется таблица или скалярное значение):</p>
<pre class="highlight literal-block">
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select(1)</span></code>
</pre>
<p>Во втором случае Tarantool вернет два кортежа: <code class="docutils literal"><span class="pre">{1,</span> <span class="pre">'A'}</span></code> и <code class="docutils literal"><span class="pre">{1,</span> <span class="pre">'B'}</span></code>. При необходимости можно задать даже нулевые поля, в результате чего Tarantool вернет все три кортежа.</p>
</li>
</ol>
<p><strong>Примеры:</strong></p>
<ul>
<li><p class="first">Пример работы с BITSET-индексом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bitset_example&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bitset&#39;</span><span class="p">,{</span><span class="n">unique</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">BITSET&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">bitset</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">iterator</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">BITS_ANY_SET&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Мы получим следующий результат:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">7</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">4</span><span class="p p-Indicator">,</span> <span class="nv">3</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>поскольку (7 AND 2) не равно 0 и (3 AND 2) не равно 0.</p>
<p>При поиске по BITSET-индексам можно использовать операторы BITS_ANY_SET, BITS_ALL_SET, BITS_ALL_NOT_SET, EQ и ALL.</p>
</li>
<li><p class="first">Пример работы с RTREE-индексом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rtree_example&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rtree&#39;</span><span class="p">,{</span><span class="n">unique</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">RTREE&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">ARRAY&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">rtree</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GT&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Мы получим следующий результат:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">9</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">]]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>поскольку прямоугольник с углами в координатах 4,7,5,9 лежит целиком внутри прямоугольника с углами в координатах 3,5,9,10.</p>
<p>При поиске по RTREE-индексам можно использовать операторы GT, GE, LT, LE, OVERLAPS и NEIGHBOR.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="transaction-control">
<span id="id1"></span><h2>3.2. Контроль транзакций<a class="headerlink" href="#transaction-control" title="Ссылка на этот заголовок">¶</a></h2>
<p id="atomic-atomic-execution">In several places in this manual, it&#8217;s been noted that Lua processes occur in
fibers on a single thread. That is why there can be a guarantee of execution
atomicity. That requires emphasis.</p>
<div class="section" id="cooperative-multitasking-environment">
<span id="atomic-cooperative-multitasking"></span><h3>3.2.1. Среда взаимной многозадачности<a class="headerlink" href="#cooperative-multitasking-environment" title="Ссылка на этот заголовок">¶</a></h3>
<p>Tarantool uses cooperative multitasking: unless a running fiber deliberately
yields control, it is not preempted by some other fiber. But a running fiber
will deliberately yield when it encounters a &#8220;yield point&#8221;: an explicit
<cite>yield()</cite> request, or an implicit yield due to an operating-system call. Any
system call which can block will be performed asynchronously, and any running
fiber which must wait for a system call will be preempted so that another
ready-to-run fiber takes its place and becomes the new running fiber. This model
makes all programmatic locks unnecessary: cooperative multitasking ensures that
there will be no concurrency around a resource, no race conditions, and
no memory consistency issues.</p>
<p>When requests are small, for example simple UPDATE or INSERT or DELETE or SELECT,
fiber scheduling is fair: it takes only a little time to process the request,
schedule a disk write, and yield to a fiber serving the next client.</p>
<p>However, a function might perform complex computations or might be written in
such a way that yields do not occur for a long time. This can lead to unfair
scheduling, when a single client throttles the rest of the system, or to
apparent stalls in request processing. Avoiding this situation is the
responsibility of the function&#8217;s author. For the default memtx storage engine
some of the box calls, including the data-change requests
<a class="reference internal" href="box_space.html#box-space-insert"><span class="std std-ref">box.space...insert</span></a> or
<a class="reference internal" href="box_space.html#box-space-update"><span class="std std-ref">box.space...update</span></a> or
<a class="reference internal" href="box_space.html#box-space-delete"><span class="std std-ref">box.space...delete</span></a>, will usually cause yielding;
however, <a class="reference internal" href="box_space.html#box-space-select"><span class="std std-ref">box.space...select</span></a> will not. A fuller
description will appear in section
<a class="reference internal" href="#atomic-the-implicit-yield-rules"><span class="std std-ref">Implicit yields</span></a>.</p>
<p>Note re storage engine: vinyl has different rules:
insert or update or delete will very rarely cause
a yield, but select can cause a yield.</p>
<p>In the absence of transactions, any function that contains yield points may see
changes in the database state caused by fibers that preempt. Then the only safe
atomic functions for memtx databases would be functions which contain only one
database request, or functions which contain a select request followed by a
data-change request.</p>
<p>At this point an objection could arise: &#8220;It&#8217;s good that a single data-change
request will commit and yield, but surely there are times when multiple
data-change requests must happen without yielding.&#8221; The standard example is the
money-transfer, where $1 is withdrawn from account #1 and deposited into
account #2. If something interrupted after the withdrawal, then the institution
would be out of balance. For such cases, the <code class="docutils literal"><span class="pre">begin</span> <span class="pre">...</span> <span class="pre">commit|rollback</span></code>
block was designed.</p>
<span class="target" id="atomic-box-begin"></span><dl class="function">
<dt id="lua-функция.box.begin">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">begin</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.begin" title="Ссылка на это определение">¶</a></dt>
<dd><p>Begin the transaction. Disable implicit yields until the transaction ends.
Signal that writes to the write-ahead log will be deferred until the transaction ends.
In effect the fiber which executes <code class="docutils literal"><span class="pre">box.begin()</span></code> is starting an &#8220;active
multi-request transaction&#8221;, blocking all other fibers.</p>
</dd></dl>

<span class="target" id="atomic-box-commit"></span><dl class="function">
<dt id="lua-функция.box.commit">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">commit</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.commit" title="Ссылка на это определение">¶</a></dt>
<dd><p>End the transaction, and make all its data-change
operations permanent.</p>
</dd></dl>

<span class="target" id="atomic-box-rollback"></span><dl class="function">
<dt id="lua-функция.box.rollback">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">rollback</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.rollback" title="Ссылка на это определение">¶</a></dt>
<dd><p>End the transaction, but cancel all its data-change
operations. An explicit call to functions outside <code class="docutils literal"><span class="pre">box.space</span></code> that always
yield, such as <code class="docutils literal"><span class="pre">fiber.yield</span></code> or <code class="docutils literal"><span class="pre">fiber.sleep</span></code>, will have the same effect.</p>
</dd></dl>

<p>The <strong>requests in a transaction must be sent to the server as a single block</strong>.
It is not enough to enclose them between <code class="docutils literal"><span class="pre">begin</span></code> and <code class="docutils literal"><span class="pre">commit</span></code> or <code class="docutils literal"><span class="pre">rollback</span></code>.
To ensure they are sent as a single block: put them in a function, or put them all
on one line, or use a delimiter so that multi-line requests are handled together.</p>
<p><strong>All database operations in a transaction should use the same storage engine</strong>.
It is not safe to access tuple sets that are defined with <code class="docutils literal"><span class="pre">{engine='vinyl'}</span></code>
and also access tuple sets that are defined with <code class="docutils literal"><span class="pre">{engine='memtx'}</span></code>,
in the same transaction.</p>
<div class="section" id="example">
<h4>3.2.1.1. Пример<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<p>Assuming that in tuple set &#8216;tester&#8217; there are tuples in which the third field
represents a positive dollar amount ... Start a transaction, withdraw from tuple#1,
deposit in tuple#2, and end the transaction, making its effects permanent.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">txn_example</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount_of_money</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">-&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">amount_of_money</span><span class="p">}})</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">to</span><span class="p">,</span>   <span class="p">{{</span><span class="s1">&#39;</span><span class="s">+&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">amount_of_money</span><span class="p">}})</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="s2">&quot;</span><span class="s">ok&quot;</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">txn_example</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{</span><span class="mi">1000</span><span class="p">},</span> <span class="mf">1.00</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&quot;ok&quot;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="implicit-yields">
<span id="atomic-the-implicit-yield-rules"></span><h3>3.2.2. Implicit yields<a class="headerlink" href="#implicit-yields" title="Ссылка на этот заголовок">¶</a></h3>
<p>The only explicit yield requests are <a class="reference internal" href="../../reference/reference_lua/fiber.html#fiber-sleep"><span class="std std-ref">fiber.sleep()</span></a> and
<a class="reference internal" href="../../reference/reference_lua/fiber.html#fiber-yield"><span class="std std-ref">fiber.yield()</span></a>, but many other requests &#8220;imply&#8221; yields
because Tarantool is designed to avoid blocking.</p>
<p>The implicit yield requests are: <a class="reference internal" href="box_space.html#box-space-insert"><span class="std std-ref">insert</span></a>
<a class="reference internal" href="box_space.html#box-space-replace"><span class="std std-ref">replace</span></a> <a class="reference internal" href="box_space.html#box-space-update"><span class="std std-ref">update</span></a>
<a class="reference internal" href="box_space.html#box-space-upsert"><span class="std std-ref">upsert</span></a> <a class="reference internal" href="box_space.html#box-space-delete"><span class="std std-ref">delete</span></a> (the
&#8220;data-change&#8221; requests), and functions in module <a class="reference internal" href="../../reference/reference_lua/fio.html#fio-section"><span class="std std-ref">fio</span></a>,
<a class="reference internal" href="../../reference/reference_lua/net_box.html#net-box-module"><span class="std std-ref">net_box</span></a>, <a class="reference internal" href="../../reference/reference_lua/console.html#console-module"><span class="std std-ref">console</span></a>, or
<a class="reference internal" href="../../reference/reference_lua/socket.html#socket-module"><span class="std std-ref">socket</span></a> (the &#8220;os&#8221; and &#8220;network&#8221; requests).</p>
<p>Note re storage engine: vinyl causes <a class="reference internal" href="box_space.html#box-space-select"><span class="std std-ref">select</span></a>
to be an implicit yield request, but data-change requests may not be.</p>
<p>The yield occurs just before a blocking syscall, such as a write to the
Write-Ahead Log (WAL) or a network message reception.</p>
<p>Implicit yield requests are disabled by <a class="reference internal" href="#atomic-box-begin"><span class="std std-ref">box.begin</span></a>,
and enabled again by <a class="reference internal" href="#atomic-box-commit"><span class="std std-ref">commit</span></a>. Therefore the sequence</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">begin</span>
<span class="n">implicit</span> <span class="k">yield</span> <span class="n">request</span> <span class="c1">#1</span>
<span class="n">implicit</span> <span class="k">yield</span> <span class="n">request</span> <span class="c1">#2</span>
<span class="n">implicit</span> <span class="k">yield</span> <span class="n">request</span> <span class="c1">#3</span>
<span class="n">commit</span>
</pre></div>
</div>
<p>will not cause implicit yield until the commit occurs (specifically: just before
the writes to the WAL, which are delayed until commit time). The commit request
is not itself an implicit yield request, it only enables yields caused by
earlier implicit yield requests.</p>
<p>Despite their resemblance to implicit yield requests,
<a class="reference internal" href="box_space.html#box-space-truncate"><span class="std std-ref">truncate</span></a> and <a class="reference internal" href="box_space.html#box-space-drop"><span class="std std-ref">drop</span></a> do not
cause implicit yield.
Despite their resemblance to functions of the fio module,
functions of the standard Lua module
<a class="reference external" href="http://www.lua.org/manual/5.1/manual.html#5.8">os</a>
do not cause implicit yield.
Despite its resemblance to commit, <a class="reference internal" href="#atomic-box-rollback"><span class="std std-ref">rollback</span></a> does
not enable yields.</p>
<p>If <a class="reference internal" href="../../reference/configuration/index.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a> = &#8216;none&#8217;, then
implicit yielding is disabled, because there are no writes to the WAL.</p>
<p>If a task is interactive &#8211; sending requests to the server and receiving
responses &#8211; then it involves network IO, and therefore there is an implicit
yield, even if the request that is sent to the server is not itself an implicit
yield request. Therefore the sequence</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">select</span>
<span class="n">select</span>
<span class="n">select</span>
</pre></div>
</div>
<p>causes blocking if it is inside a function or Lua program being executed on the
server, but causes yielding if it is done as a series of transmissions from a
client, including a client which operates via telnet, via one of the connectors,
or via the MySQL and PostgreSQL rocks, or via the interactive mode when
<a class="reference internal" href="../administration.html#administration-using-tarantool-as-a-client"><span class="std std-ref">&#8220;Using tarantool as a client&#8221;</span></a>.</p>
<p>After a fiber has yielded and then has regained control, it immediately issues
<a class="reference internal" href="../../reference/reference_lua/fiber.html#fiber-testcancel"><span class="std std-ref">testcancel</span></a>.</p>
</div>
</div>
<div class="section" id="access-control">
<h2>3.3. Ограничение доступа<a class="headerlink" href="#access-control" title="Ссылка на этот заголовок">¶</a></h2>
<p id="authentication">Understanding the details of security is primarily an issue for administrators,
but ordinary users should at least skim this section so that they will have an
idea of how Tarantool makes it possible for administrators to prevent
unauthorized access to the database and to certain functions.</p>
<p>Briefly: there is a method to guarantee with password checks that users really
are who they say they are (&#8220;authentication&#8221;). There is a _user space where user
names and password-hashes are stored. There are functions for saying that
certain users are allowed to do certain things (&#8220;privileges&#8221;). There is a _priv
space where privileges are stored. Whenever a user tries to do an operation,
there is a check whether the user has the privilege to do the operation
(&#8220;access control&#8221;).</p>
<div class="section" id="passwords">
<h3>3.3.1. Passwords<a class="headerlink" href="#passwords" title="Ссылка на этот заголовок">¶</a></h3>
<p>Each user may have a password. The password is any alphanumeric string.
Administrators should advise users to choose long unobvious passwords, but it
is ultimately up to the users to choose or change their own passwords.</p>
<p>Tarantool passwords are stored in the _user space with a <a class="reference external" href="https://en.wikipedia.org/wiki/Cryptographic_hash">Cryptographic hash function</a>
so that, if the password is &#8216;x&#8217;, the stored hashed-password is a long string
like &#8216;<code class="docutils literal"><span class="pre">lL3OvhkIPOKh+Vn9Avlkx69M/Ck=</span></code>&#8216;. When a client connects to a Tarantool
server, the server sends a random <a class="reference external" href="https://en.wikipedia.org/wiki/Salt_%28cryptography%29">Salt Value</a> which the client must mix with the
hashed-password before sending to the server. Thus the original value &#8216;x&#8217; is
never stored anywhere except in the user&#8217;s head, and the hashed value is never
passed down a network wire except when mixed with a random salt. This system
prevents malicious onlookers from finding passwords by snooping in the log
files or snooping on the wire. It is the same system that <a class="reference external" href="http://dev.mysql.com/doc/refman/4.1/en/password-hashing.html">MySQL introduced
several years ago</a> which has proved adequate for medium-security installations.
Nevertheless administrators should warn users that no system is foolproof against
determined long-term attacks, so passwords should be guarded and changed occasionally.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">To get the hash-password of a string &#8216;X&#8217;, say
<code class="docutils literal"><span class="pre">box.schema.user.password('X')</span></code>. To see more about the details of the
algorithm for the purpose of writing a new client application, read the
<a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/scramble.h">scramble.h</a> header file.</p>
</div>
</div>
<div class="section" id="users-and-the-user-space">
<span id="authentication-users"></span><h3>3.3.2. Users and the _user space<a class="headerlink" href="#users-and-the-user-space" title="Ссылка на этот заголовок">¶</a></h3>
<p>The fields in the _user space are:</p>
<ul class="simple">
<li>the numeric id of the tuple</li>
<li>the numeric id of the tuple&#8217;s creator</li>
<li>the user name</li>
<li>the type</li>
<li>optional password</li>
</ul>
<p>There are four special tuples in the _user space: &#8216;guest&#8217;, &#8216;admin&#8217;, &#8216;public&#8217;, and &#8216;replication&#8217;.</p>
<div class="table container">
<table border="1" class="left-align-column-1 right-align-column-2 left-align-column-3 left-align-column-4 docutils">
<colgroup>
<col width="16%" />
<col width="5%" />
<col width="8%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">ID</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>guest</td>
<td>0</td>
<td>user</td>
<td>Default when connecting remotely. Usually an untrusted
user with few privileges.</td>
</tr>
<tr class="row-odd"><td>admin</td>
<td>1</td>
<td>user</td>
<td>Default when using <code class="docutils literal"><span class="pre">tarantool</span></code> as a console. Usually
an administrative user with all privileges.</td>
</tr>
<tr class="row-even"><td>public</td>
<td>2</td>
<td>role</td>
<td>Not a user in the usual sense. Described later in
section <a class="reference internal" href="#roles">Roles</a>.</td>
</tr>
<tr class="row-odd"><td>replication</td>
<td>3</td>
<td>role</td>
<td>Not a user in the usual sense. Described later in
section <a class="reference internal" href="#roles">Roles</a>.</td>
</tr>
</tbody>
</table>
</div>
<p>To select a row from the _user space, use <code class="docutils literal"><span class="pre">box.space._user:select</span></code>. For
example, here is what happens with a select for user id = 0, which is the
&#8216;guest&#8217; user, which by default has no password:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_user</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;guest&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;user&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>To change tuples in the _user space, do not use ordinary <code class="docutils literal"><span class="pre">box.space</span></code>
functions for insert or update or delete - the _user space is special so
there are special functions which have appropriate error checking.</p>
<p>To create a new user, say:</p>
<pre class="highlight literal-block">
box.schema.user.create(<em>user-name</em>)
box.schema.user.create(<em>user-name</em>, {if_not_exists = true})
box.schema.user.create(<em>user-name</em>, {password = <em>password</em>}).
</pre>
<p>The <code class="samp docutils literal"><span class="pre">password=</span><em><span class="pre">password</span></em></code> specification is good because in a <a class="reference internal" href="../../reference/configuration/index.html#index-uri"><span class="std std-ref">URI</span></a> (Uniform Resource Identifier) it is
usually illegal to include a user-name without a password.</p>
<p>To change the user&#8217;s password, say:</p>
<pre class="highlight literal-block">
-- To change the current user's password
box.schema.user.passwd(<em>password</em>)

-- To change a different user's password
box.schema.user.passwd(<em>user-name</em>, <em>password</em>)
</pre>
<p>(Usually it is only the admin user who can change a different user&#8217;s password.)</p>
<p>To drop a user, say:</p>
<pre class="highlight literal-block">
box.schema.user.drop(<em>user-name</em>).
</pre>
<p>To check whether a user exists, say:</p>
<pre class="highlight literal-block">
box.schema.user.exists(<em>user-name</em>)
</pre>
<p>which returns true or false.</p>
<p>To find what privileges a user has, say:</p>
<pre class="highlight literal-block">
box.schema.user.info(<em>user-name</em>)
</pre>
<p><strong>Example:</strong></p>
<p>Here is a session which creates a new user with a strong password, selects a
tuple in the _user space, and then drops the user.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">JeanMartin&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Iwtso_6_os$$&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_user</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">name</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">JeanMartin&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">17</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;JeanMartin&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;user&#39;</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">{</span><span class="s">&#39;chap-sha1&#39;</span><span class="p p-Indicator">:</span> <span class="s">&#39;t3xjUpQdrt857O+YRvGbMY5py8Q=&#39;</span><span class="p p-Indicator">}]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">JeanMartin&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">The maximum number of users is 32.</p>
</div>
</div>
<div class="section" id="privileges-and-the-priv-space">
<span id="authentication-privileges"></span><h3>3.3.3. Privileges and the _priv space<a class="headerlink" href="#privileges-and-the-priv-space" title="Ссылка на этот заголовок">¶</a></h3>
<p>The fields in the _priv space are:</p>
<ul class="simple">
<li>the numeric id of the user who gave the privilege (&#8220;grantor_id&#8221;),</li>
<li>the numeric id of the user who received the privilege (&#8220;grantee_id&#8221;),</li>
<li>the type of object - &#8220;space&#8221; or &#8220;function&#8221; or &#8220;universe&#8221;,</li>
<li>the numeric id of the object,</li>
<li>the type of operation - &#8220;read&#8221; = 1, or &#8220;write&#8221; = 2, or &#8220;execute&#8221; = 4, or a
combination such as &#8220;read,write,execute&#8221;.</li>
</ul>
<p>The function for granting a privilege is:</p>
<pre class="highlight literal-block">
box.schema.user.grant(<em>grantee</em>, <em>operation</em>, <em>object-type</em>, <em>object-name*[, *options</em>])
-- OR
box.schema.user.grant(<em>grantee</em>, <em>operation</em>, 'universe' [, nil, <em>options</em>])
</pre>
<p>where &#8216;universe&#8217; means &#8216;all objects&#8217;, and the optional grant-option can be:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">grantor=</span><em><span class="pre">grantor_name_or_id</span></em></code> - string or number, for custom grantor</li>
<li><code class="samp docutils literal"><span class="pre">if_not_exists=true|false</span></code> - bool, do not throw error if user already has the privilege</li>
</ul>
<p>The function for revoking a privilege is:</p>
<pre class="highlight literal-block">
box.schema.user.revoke(<em>grantee</em>, <em>operation</em>, <em>object-type</em>, <em>object-name*[, *options</em>])
box.schema.user.revoke(<em>grantee</em>, <em>operation</em>, 'universe'[, nil, <em>options</em>])
</pre>
<p>where &#8216;universe&#8217; means &#8216;all objects&#8217;, and the optional grant-option can be:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">if_not_exists=true|false</span></code> - bool, do not throw error if user already lacks the privilege</li>
</ul>
<p>For example, here is a session where the admin user gave the guest user the
privilege to read from a space named <code class="docutils literal"><span class="pre">space55</span></code>, and then took the privilege away:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Generally privileges are granted or revoked by the owner of the object
(the user who created it), or by the &#8216;admin&#8217; user.
Before dropping any objects or users, steps should be taken to ensure
that all their associated privileges have been revoked.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Only the &#8216;admin&#8217; user can grant privileges for the &#8216;universe&#8217;.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Only the creator of a space can drop, alter, or truncate the space.
Only the creator of a user can change a different user&#8217;s password.</p>
</div>
</div>
<div class="section" id="functions-and-the-func-space">
<span id="authentication-funcs"></span><h3>3.3.4. Functions and the _func space<a class="headerlink" href="#functions-and-the-func-space" title="Ссылка на этот заголовок">¶</a></h3>
<p>The fields in the _func space are:</p>
<ul class="simple">
<li>the numeric function id, a number,</li>
<li>the function name</li>
<li>flag</li>
<li>possibly a language name.</li>
</ul>
<p>The _func space does not include the function&#8217;s body. One continues to
create Lua functions in the usual way, by saying
&#8220;<code class="samp docutils literal"><span class="pre">function</span> <em><span class="pre">function_name</span></em> <span class="pre">()</span> <span class="pre">...</span> <span class="pre">end</span></code>&#8221;, without adding anything in the
_func space. The _func space only exists for storing function tuples so
that their names can be used within grant/revoke functions.</p>
<p>The function for creating a _func tuple is:</p>
<pre class="highlight literal-block">
box.schema.func.create(<em>function-name</em> [, <em>options</em>])
</pre>
<p>The possible options are:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">if_not_exists</span> <span class="pre">=</span> <em><span class="pre">true|false</span></em></code> - default = false,</li>
<li><code class="samp docutils literal"><span class="pre">setuid</span> <span class="pre">=</span> <em><span class="pre">true|false</span></em></code> - default = false,</li>
<li><code class="samp docutils literal"><span class="pre">language</span> <span class="pre">=</span> <em><span class="pre">'LUA'|'C'</span></em></code> - default = &#8216;LUA&#8217;.</li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">,</span> <span class="n">setuid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
</pre></div>
</div>
<p>Specifying <code class="code docutils literal"><span class="pre">if_not_exists=false</span></code> would cause <code class="docutils literal"><span class="pre">error:</span> <span class="pre">Function</span> <span class="pre">'...'</span> <span class="pre">already</span>
<span class="pre">exists</span></code> if the _func tuple already exists.</p>
<p>Specifying <code class="code docutils literal"><span class="pre">setuid=true</span></code> would cause the setuid flag (the fourth field in
the _func tuple) to have a value meaning &#8220;true&#8221;, and the effect of that is that
the function&#8217;s caller is treated as the function&#8217;s creator, with full privileges.
The setuid behavior does not apply for users who connect via <code class="code docutils literal"><span class="pre">console.connect</span></code>.</p>
<p>Specifying <code class="code docutils literal"><span class="pre">language='C'</span></code> would cause the language field (the fifth field
in the _func tuple) to have a value &#8216;C&#8217;, which means the function was written in
C. Tarantool functions are normally written in Lua but can be written in C as well.</p>
<p>The function for dropping a _func tuple is:</p>
<pre class="highlight literal-block">
box.schema.func.drop(<em>function-name</em>)
</pre>
<p>The function for checking whether a _func tuple exists is:</p>
<pre class="highlight literal-block">
box.schema.func.exists(<em>function-name</em>)
</pre>
<p>In the following example, a function named &#8216;f7&#8217; is created, then it is put in
the _func space, then it is used in a <code class="docutils literal"><span class="pre">box.schema.user.grant</span></code> function,
then it is dropped:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f7</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">uid</span><span class="p">()</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="box-session-and-security">
<h3>3.3.5. box.session and security<a class="headerlink" href="#box-session-and-security" title="Ссылка на этот заголовок">¶</a></h3>
<p>After a connection has taken place, the user has access to a &#8220;session&#8221; object
which has several functions. The ones which are of interest for security
purposes are:</p>
<pre class="highlight literal-block">
box.session.uid()         -- returns the id of the current user
box.session.user()        -- returns the name of the current user
box.session.su(<em>user-name</em>) -- allows changing current user to 'user-name'
</pre>
<p>If a user types requests directly on the Tarantool server in its
<a class="reference internal" href="../administration.html#administration-using-tarantool-as-a-client"><span class="std std-ref">interactive mode</span></a>,
or if a user connects to the <a class="reference internal" href="../administration.html#administration-admin-ports"><span class="std std-ref">admin port</span></a>,
then the user by default is &#8216;admin&#8217; and has many privileges.
If a user connects from an application program via one of the <a class="reference internal" href="../connectors/index.html#index-box-connectors"><span class="std std-ref">connectors</span></a>, then
the user by default is &#8216;guest&#8217; and has few privileges. Typically an admin user
will set up and configure objects, then grant privileges to appropriate non-admin
users. Typically a guest user will use <code class="docutils literal"><span class="pre">box.session.su()</span></code> to change into a non-generic
user to whom admin has granted more than the default privileges. For example,
admin might say:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_user</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">123456</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">user&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">_space&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">payroll&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and later a guest user, who wishes to see the payroll, might say:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">su</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">payroll</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Jones&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="roles">
<span id="authentication-roles"></span><h3>3.3.6. Roles<a class="headerlink" href="#roles" title="Ссылка на этот заголовок">¶</a></h3>
<p>A role is a container for privileges which can be granted to regular users.
Instead of granting and revoking individual privileges, one can put all the
privileges in a role and then grant or revoke the role. Role information is
in the _user space but the third field - the type field - is &#8216;role&#8217; rather
than &#8216;user&#8217;.</p>
<p id="authentication-rep-role">If a role R1 is granted a privilege X, and user U1 is granted a privilege
&#8220;role R1&#8221;, then user U1 in effect has privilege X. Then if a role R2 is
granted a privilege Y, and role R1 is granted a privilege &#8220;role R2&#8221;,
then user U1 in effect has both privilege X and privilege Y. In other words,
a user gets all the privileges that are granted to a user&#8217;s roles, directly
or indirectly.</p>
<span class="target" id="lua-module.box.schema.role"></span><dl class="function">
<dt id="lua-функция.box.schema.role.create">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">create</code><big>(</big><em>role-name</em><span class="optional">[</span>, <em>{if_not_exists=true}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a new role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.grant">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">grant</code><big>(</big><em>role-name</em>, <em>privilege</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.grant" title="Ссылка на это определение">¶</a></dt>
<dd><p>Put a privilege in a role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.revoke">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">revoke</code><big>(</big><em>role-name</em>, <em>privilege</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.revoke" title="Ссылка на это определение">¶</a></dt>
<dd><p>Take a privilege out of a role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.drop">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">drop</code><big>(</big><em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.drop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Drop a role.</p>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">grant</code><big>(</big><em>role-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big></dt>
<dd><p>Grant a role to a role.</p>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">revoke</code><big>(</big><em>role-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big></dt>
<dd><p>Revoke a role from a role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.exists">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">exists</code><big>(</big><em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.exists" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check whether a role exists.
Returns (type = boolean) true if role-name identifies a role, otherwise false.</p>
</dd></dl>

<span class="target" id="lua-module.box.schema.user"></span><dl class="function">
<dt id="lua-функция.box.schema.user.grant">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">grant</code><big>(</big><em>user-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.grant" title="Ссылка на это определение">¶</a></dt>
<dd><p>Grant a role to a user.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.revoke">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">revoke</code><big>(</big><em>user-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.revoke" title="Ссылка на это определение">¶</a></dt>
<dd><p>Revoke a role from a user.</p>
</dd></dl>

<p>There are two predefined roles. The first predefined role, named &#8216;public&#8217;, is
automatically assigned to new users when they are created with
<code class="samp docutils literal"><span class="pre">box.schema.user.create(</span><em><span class="pre">user-name</span></em><span class="pre">)</span></code> - Therefore a convenient way to
grant &#8216;read&#8217; on space &#8216;t&#8217; to every user that will ever exist is:
<code class="code docutils literal"><span class="pre">box.schema.role.grant('public','read','space','t')</span></code>. The second
predefined role, named &#8216;replication&#8217;, can be assigned by the &#8216;admin&#8217; user to
users who need to use replication features.</p>
<div class="section" id="example-showing-a-role-within-a-role">
<h4>3.3.6.1. Example showing a role within a role<a class="headerlink" href="#example-showing-a-role-within-a-role" title="Ссылка на этот заголовок">¶</a></h4>
<p>In this example, a new user named U1 will insert a new tuple into a new space
named T, and will succeed even though user U1 has no direct privilege to do
such an insert &#8211; that privilege is inherited from role R1, which in turn
inherits from role R2.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- This example will work for a user with many privileges, such as &#39;admin&#39;</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">T&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="c1">-- Create a user U1 so that later it&#39;s possible to say box.session.su(&#39;U1&#39;)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">U1&#39;</span><span class="p">)</span>
<span class="c1">-- Create two roles, R1 and R2</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R1&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">)</span>
<span class="c1">-- Grant role R2 to role R1 and role R1 to U1 (order doesn&#39;t matter)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">role&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">U1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">role&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">R1&#39;</span><span class="p">)</span>
<span class="c1">-- Grant read and execute privileges to R2 (but not to R1 and not to U1)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">T&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="c1">-- Use box.session.su to say &quot;now become user U1&quot;</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">su</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">U1&#39;</span><span class="p">)</span>
<span class="c1">-- Next insert succeeds because U1 in effect has write privilege on T</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="triggers">
<h2>3.4. Триггеры<a class="headerlink" href="#triggers" title="Ссылка на этот заголовок">¶</a></h2>
<p id="triggers-box-triggers"><span id="id2"></span><em>Triggers</em>, also known as <em>callbacks</em>, are functions which the server executes
when certain events happen. Currently the main types of triggers are
<a class="reference internal" href="#triggers-connection-triggers"><span class="std std-ref">connection triggers</span></a>,
which are executed when a session begins or ends, and
<a class="reference internal" href="#triggers-replace-triggers"><span class="std std-ref">replace triggers</span></a>,
which are for database events.</p>
<p>All triggers have the following characteristics:</p>
<ul class="simple">
<li>They associate a <cite>function</cite> with an <cite>event</cite>. The request to &#8220;define a trigger&#8221;
consists of passing the name of the trigger&#8217;s function to one of the
&#8220;<code class="samp docutils literal"><span class="pre">on_</span><em><span class="pre">event-name</span></em><span class="pre">()</span></code>&#8221; functions: <code class="code docutils literal"><span class="pre">on_connect()</span></code>, <code class="code docutils literal"><span class="pre">on_auth()</span></code>,
<code class="code docutils literal"><span class="pre">on_disconnect()</span></code>, or <code class="code docutils literal"><span class="pre">on_replace()</span></code>.</li>
<li>They are <cite>defined by any user</cite>. There are no privilege requirements for defining
triggers.</li>
<li>They are called <cite>after</cite> the event. They are not called if the event ends
prematurely due to an error. (Exception: <code class="code docutils literal"><span class="pre">on_auth()</span></code> is called before the event.)</li>
<li>They are in <cite>server memory</cite>. They are not stored in the database. Triggers
disappear when the server is shut down. If there is a requirement to make
them permanent, then the function definitions and trigger settings should
be part of an initialization script.</li>
<li>They have <cite>low overhead</cite>. If a trigger is not defined, then the overhead is
minimal: merely a pointer dereference and check. If a trigger is defined,
then its overhead is equivalent to the overhead of calling a stored procedure.</li>
<li>They can be <cite>multiple</cite> for one event. Triggers are executed in the reverse
order that they were defined in.</li>
<li>They must work <cite>within the event context</cite>. If the function contains requests
which normally could not occur immediately after the event but before the
return from the event, effects are undefined. For example, putting
<code class="docutils literal"><span class="pre">os.exit()</span></code> or <code class="docutils literal"><span class="pre">box.rollback()</span></code> in a trigger function would be bringing in requests
outside the event context.</li>
<li>They are <cite>replaceable</cite>. The request to &#8220;redefine a trigger&#8221; consists of passing
the names of a new trigger function and an old trigger function to one of the
&#8220;on <cite>event-name</cite> ...&#8221; functions.</li>
</ul>
<div class="section" id="connection-triggers">
<span id="triggers-connection-triggers"></span><h3>3.4.1. Connection triggers<a class="headerlink" href="#connection-triggers" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="function">
<dt id="lua-функция.box.session.on_connect">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">on_connect</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.session.on_connect" title="Ссылка на это определение">¶</a></dt>
<dd><p>Define a trigger for execution when a new session is created due to an event
such as <a class="reference internal" href="../../reference/reference_lua/console.html#console-connect"><span class="std std-ref">console.connect</span></a>. The trigger function will be the first thing
executed after a new session is created. If the trigger fails by raising an
error, the error is sent to the client and the connection is closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) &#8211; function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) &#8211; existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil or function list</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Предупреждение</p>
<p class="last">If a trigger always results in an error, it may become impossible to
connect to the server to reset it.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.session.on_disconnect">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">on_disconnect</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.session.on_disconnect" title="Ссылка на это определение">¶</a></dt>
<dd><p>Define a trigger for execution after a client has disconnected. If the trigger
function causes an error, the error is logged but otherwise is ignored. The
trigger is invoked while the session associated with the client still exists
and can access session properties, such as box.session.id.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) &#8211; function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) &#8211; existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil or function list</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_disconnect</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="id3">
<h4>3.4.1.1. Пример<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h4>
<p>After the following series of requests, the server will write a message
using the <a class="reference internal" href="../../reference/reference_lua/log.html#log"><span class="std std-ref">log</span></a> module whenever any user connects or disconnects.</p>
<div class="highlight-lua_tarantool"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">log_connect</span> <span class="p">()</span>
  <span class="kd">local</span> <span class="n">log</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">log&#39;</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Connection. user=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">user</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> id=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">id</span><span class="p">()</span>
  <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">log_disconnect</span> <span class="p">()</span>
  <span class="kd">local</span> <span class="n">log</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">log&#39;</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Disconnection. user=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">user</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> id=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">id</span><span class="p">()</span>
  <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">(</span><span class="n">log_connect</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_disconnect</span><span class="p">(</span><span class="n">log_disconnect</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is what might appear in the log file in a typical installation:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">34.444</span> <span class="p">[</span><span class="mi">11360</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">103</span><span class="o">/</span><span class="n">iproto</span> <span class="n">I</span><span class="o">&gt;</span>
    <span class="n">Connection</span><span class="p">.</span> <span class="n">user</span><span class="o">=</span><span class="n">guest</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">19.289</span> <span class="p">[</span><span class="mi">11360</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">103</span><span class="o">/</span><span class="n">iproto</span> <span class="n">I</span><span class="o">&gt;</span>
    <span class="n">Disconnection</span><span class="p">.</span> <span class="n">user</span><span class="o">=</span><span class="n">guest</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="authentication-triggers">
<span id="triggers-authentication-triggers"></span><h3>3.4.2. Authentication triggers<a class="headerlink" href="#authentication-triggers" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="function">
<dt id="lua-функция.box.session.on_auth">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">on_auth</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.session.on_auth" title="Ссылка на это определение">¶</a></dt>
<dd><p>Define a trigger for execution during authentication.</p>
<p>The on_auth trigger function is invoked in these circumstances:
(1) The <a class="reference internal" href="../../reference/reference_lua/console.html#console-connect"><span class="std std-ref">console.connect</span></a> function includes an authentication check for all users except &#8216;guest&#8217;;
for this case the on_auth trigger function is invoked after the on_connect trigger function,
if and only if the connection has succeeded so far.
(2) The binary protocol has a separate <a class="reference internal" href="../../dev_guide/internals_index.html#box-protocol-authentication"><span class="std std-ref">authentication packet</span></a> &#8211;
for this case, connection and authentication are considered to be separate steps.</p>
<p>Unlike other trigger types, on_auth trigger functions are invoked <cite>before</cite>
the event. Therefore a trigger function like <code class="code docutils literal"><span class="pre">function</span> <span class="pre">auth_function</span> <span class="pre">()</span> <span class="pre">v</span> <span class="pre">=</span> <span class="pre">box.session.user();</span> <span class="pre">end</span></code>
will set <code class="code docutils literal"><span class="pre">v</span></code> to &#8220;guest&#8221;, the user name before the authentication is done.
To get the user name after the authentication is done, use the special syntax:
<code class="code docutils literal"><span class="pre">function</span> <span class="pre">auth_function</span> <span class="pre">(user_name)</span> <span class="pre">v</span> <span class="pre">=</span> <span class="pre">user_name;</span> <span class="pre">end</span></code></p>
<p>If the trigger fails by raising an
error, the error is sent to the client and the connection is closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) &#8211; function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) &#8211; existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_auth</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="lua-module.box.space">
<span id="replace-triggers"></span><span id="triggers-replace-triggers"></span><h3>3.4.3. Replace triggers<a class="headerlink" href="#lua-module.box.space" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="class">
<dt id="lua-объект.box.space.space_object">
<em class="property">объект </em><code class="descclassname">box.space.</code><code class="descname">space_object</code><a class="headerlink" href="#lua-объект.box.space.space_object" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="function">
<dt id="lua-функция.space_object.on_replace">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">on_replace</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.space_object.on_replace" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a &#8220;<code class="docutils literal"><span class="pre">replace</span> <span class="pre">trigger</span></code>&#8221;. The <code class="docutils literal"><span class="pre">function-name</span></code> will be executed whenever
a <code class="docutils literal"><span class="pre">replace()</span></code> or <code class="docutils literal"><span class="pre">insert()</span></code> or <code class="docutils literal"><span class="pre">update()</span></code> or <code class="docutils literal"><span class="pre">upsert()</span></code> or <code class="docutils literal"><span class="pre">delete()</span></code> happens to a
tuple in <code class="docutils literal"><span class="pre">&lt;space-name&gt;</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) &#8211; function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) &#8211; existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil or function list</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">X</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.space_object.run_triggers">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">run_triggers</code><big>(</big><em>true|false</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.run_triggers" title="Ссылка на это определение">¶</a></dt>
<dd><p>At the time that a trigger is defined, it is automatically enabled - that
is, it will be executed. Replace triggers can be disabled with
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:run_triggers(false)</span></code> and re-enabled with
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:run_triggers(true)</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">X</span><span class="p">:</span><span class="n">run_triggers</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<div class="section" id="id4">
<h4>3.4.3.1. Пример<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h4>
<p>The following series of requests will create a space, create an index, create
a function which increments a counter, create a trigger, do two inserts, drop
the space, and display the counter value - which is 2, because the function
is executed once after each insert.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space53&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">replace_trigger</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">replace_counter</span> <span class="o">=</span> <span class="n">replace_counter</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">replace_trigger</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">replace_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">First replace&#39;</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Second replace&#39;</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="gp">tarantool&gt; </span><span class="n">replace_counter</span>
</pre></div>
</div>
</div>
<div class="section" id="another-example">
<h4>3.4.3.2. Another example<a class="headerlink" href="#another-example" title="Ссылка на этот заголовок">¶</a></h4>
<p>The following series of requests will associate an existing function named F
with an existing space named T, associate the function a second time with the
same space (so it will be called twice), disable all triggers of T, and delete
each trigger by replacing with <code class="docutils literal"><span class="pre">nil</span></code>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">run_triggers</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="getting-a-list-of-triggers">
<span id="triggers-getting-a-list-of-triggers"></span><h3>3.4.4. Getting a list of triggers<a class="headerlink" href="#getting-a-list-of-triggers" title="Ссылка на этот заголовок">¶</a></h3>
<p>You can use:</p>
<ul class="simple">
<li><code class="code docutils literal"><span class="pre">on_connect()</span></code> &#8211; with no arguments &#8211;
to return a table of all connect-trigger functions;</li>
<li><code class="code docutils literal"><span class="pre">on_auth()</span></code> to return all authentication-trigger functions;</li>
<li><code class="code docutils literal"><span class="pre">on_disconnect()</span></code> to return all disconnect-trigger functions;</li>
<li><code class="code docutils literal"><span class="pre">on_replace()</span></code> to return all replace-trigger functions.</li>
</ul>
<p>In the following example, we find that there are
three functions associated with <code class="code docutils literal"><span class="pre">on_connect</span></code>
triggers, and execute the third function, which happens to
contain the line &#8220;print(&#8216;function #3&#8217;)&#8221;.
Then we delete the third trigger.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x416ab6f8&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x416ab6f8&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x416ad800&#39;</span>
<span class="nn">...</span>

<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">()[</span><span class="mi">3</span><span class="p">]()</span>
<span class="go">function #3</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="limitations">
<h2>3.5. Ограничения<a class="headerlink" href="#limitations" title="Ссылка на этот заголовок">¶</a></h2>
<p id="limitations-fields-in-index"><strong>Number of parts in an index</strong></p>
<blockquote>
<div>For TREE or HASH indexes, the maximum
is 255 (<code class="docutils literal"><span class="pre">box.schema.INDEX_PART_MAX</span></code>). For RTREE indexes, the
maximum is 1 but the field is an ARRAY. For BITSET indexes, the maximum is 1.</div></blockquote>
<p id="limitations-indexes-in-space"><strong>Number of indexes in a space</strong></p>
<blockquote>
<div>128 (<code class="docutils literal"><span class="pre">box.schema.INDEX_MAX</span></code>).</div></blockquote>
<p id="limitations-fields-in-tuple"><strong>Number of fields in a tuple</strong></p>
<blockquote>
<div>The theoretical maximum is 2147483647 (<code class="docutils literal"><span class="pre">box.schema.FIELD_MAX</span></code>). The
practical maximum is whatever is specified by the space&#8217;s
<a class="reference internal" href="box_space.html#box-space-field-count"><span class="std std-ref">field_count</span></a>
member, or the maximum tuple length.</div></blockquote>
<p id="limitations-bytes-in-tuple"><strong>Number of bytes in a tuple</strong></p>
<blockquote>
<div>By default the value of <a class="reference internal" href="../../reference/configuration/index.html#cfg-storage-slab-alloc-maximal"><span class="std std-ref">slab_alloc_maximal</span></a>
is 1048576, and the maximum tuple length is approximately one quarter of that:
approximately 262,000 bytes. To increase it, when starting the server,
specify a larger value. For example
<code class="code docutils literal"><span class="pre">box.cfg{slab_alloc_maximal=2*1048576}</span></code>.</div></blockquote>
<p id="limitations-bytes-in-index-key"><strong>Number of bytes in an index key</strong></p>
<blockquote>
<div>If a field in a tuple can contain a million bytes, then the index key
can contain a million bytes, so the maximum is determined by factors
such as <a class="reference internal" href="limitations.html#limitations-bytes-in-tuple"><span class="std std-ref">Number of bytes in a tuple</span></a>,
not by the index support.</div></blockquote>
<p id="limitations-number-of-spaces"><strong>Number of spaces</strong></p>
<blockquote>
<div>The theoretical maximum is 2147483647 (<code class="docutils literal"><span class="pre">box.schema.SPACE_MAX</span></code>).</div></blockquote>
<p id="limitations-number-of-connections"><strong>Number of connections</strong></p>
<blockquote>
<div>The practical limit is the number of file descriptors that one can set
with the operating system.</div></blockquote>
<p id="limitations-space-size"><strong>Space size</strong></p>
<blockquote>
<div>The total maximum size for all spaces is in effect set by
<a class="reference internal" href="../../reference/configuration/index.html#cfg-storage-slab-alloc-arena"><span class="std std-ref">slab_alloc_arena</span></a>, which in turn
is limited by the total available memory.</div></blockquote>
<p id="limitations-update-ops"><strong>Update operations count</strong></p>
<blockquote>
<div>The maximum number of operations that can be in a single update
is 4000 (<code class="docutils literal"><span class="pre">BOX_UPDATE_OP_CNT_MAX</span></code>).</div></blockquote>
<p id="limitations-users-and-roles"><strong>Number of users and roles</strong></p>
<blockquote>
<div>32 (BOX_USER_MAX).</div></blockquote>
<p id="limitations-length"><strong>Length of an index name or space name or user name</strong></p>
<blockquote>
<div>32 (<code class="docutils literal"><span class="pre">box.schema.NAME_MAX</span></code>).</div></blockquote>
<p id="limitations-replicas"><strong>Number of replicas in a cluster</strong></p>
<blockquote>
<div>32 (<code class="docutils literal"><span class="pre">box.schema.REPLICA_MAX</span></code>).</div></blockquote>
<p id="limitations-vinyl">For additional limitations which apply only to the vinyl
storage engine, see section
<a class="reference internal" href="#vinyl-diff"><span class="std std-ref">Differences between memtx and vinyl</span></a>.</p>
</div>
<div class="section" id="vinyl-storage-engine">
<span id="index-vinyl"></span><h2>3.6. Дисковый движок vinyl<a class="headerlink" href="#vinyl-storage-engine" title="Ссылка на этот заголовок">¶</a></h2>
<p id="index-two-storage-engines">A storage engine is a set of very-low-level routines which actually store and
retrieve tuple values. Tarantool offers a choice of two storage engines:</p>
<ul class="simple">
<li>memtx (the in-memory storage engine) is the default and was the first to
arrive.</li>
<li>vinyl (the on-disk storage engine) is a working key-value engine and will
especially appeal to users who like to see data go directly to disk, so that
recovery time might be shorter and database size might be larger. On the other
hand, vinyl lacks some functions and options that are available with memtx.
Where that is the case, the relevant description in this manual will contain
a note beginning with the words &#8220;Note re storage engine&#8221;. See also a coverage
for all <a class="reference internal" href="#vinyl-diff"><span class="std std-ref">the differences between memtx and vinyl</span></a> further
on this page.</li>
</ul>
<p>To specify that the engine should be vinyl, add the clause <code class="docutils literal"><span class="pre">engine</span> <span class="pre">=</span> <span class="pre">'vinyl'</span></code>
when creating a space, for example:
<code class="docutils literal"><span class="pre">space</span> <span class="pre">=</span> <span class="pre">box.schema.space.create('name',</span> <span class="pre">{engine='vinyl'})</span></code>.</p>
<div class="section" id="differences-between-memtx-and-vinyl-storage-engines">
<span id="vinyl-diff"></span><h3>3.6.1. Различия между движками memtx и vinyl<a class="headerlink" href="#differences-between-memtx-and-vinyl-storage-engines" title="Ссылка на этот заголовок">¶</a></h3>
<p>The primary difference between memtx and vinyl is that memtx is an &#8220;in-memory&#8221;
engine while vinyl is an &#8220;on-disk&#8221; engine. An in-memory storage engine is
generally faster, and the memtx engine is justifiably the default for Tarantool,
but there are two situations where an on-disk engine such as vinyl would be
preferable:</p>
<ol class="arabic simple">
<li>when the database is larger than the available memory and adding more
memory is not a realistic option;</li>
<li>when the server frequently goes down due to errors or a simple desire to
save power &#8211; bringing the server back up and restoring a memtx database
into memory takes time.</li>
</ol>
<p>Here are behavior differences which affect programmers. All of these differences
have been noted elsewhere in sentences that begin with the words
&#8220;Note re storage engine: vinyl&#8221;.</p>
<ul class="simple">
<li>With memtx, the index type can be TREE or HASH or RTREE or BITSET. <br />
With vinyl, the only index type is TREE.</li>
<li>With memtx, <a class="reference internal" href="box_space.html#box-space-create-index"><span class="std std-ref">create_index</span></a> can be done at any time. <br />
With vinyl, secondary indexes must be created before tuples are inserted.</li>
<li>With memtx, for index searches, <code class="docutils literal"><span class="pre">nil</span></code> may be allowed within a search key. <br />
With vinyl, <code class="docutils literal"><span class="pre">nil</span></code> is only allowed at the end of a search key.</li>
<li>With memtx, temporary spaces are supported. <br />
With vinyl, they are not.</li>
<li>With memtx, the <a class="reference internal" href="box_index.html#box-index-alter"><span class="std std-ref">alter()</span></a> and <a class="reference internal" href="box_space.html#box-space-len"><span class="std std-ref">len()</span></a>
and <a class="reference internal" href="box_index.html#box-index-random"><span class="std std-ref">random()</span></a>
functions are supported. <br />
With vinyl, they are not.</li>
<li>With memtx, the <a class="reference internal" href="box_index.html#box-index-count"><span class="std std-ref">count()</span></a> function takes a constant
amount of time. <br />
With vinyl, it takes a variable amount of time depending on index size.</li>
<li>With memtx, delete will return deleted tuple, if any. <br />
With vinyl, delete will always return nil.</li>
</ul>
<p>It was explained <a class="reference internal" href="#index-yields-must-happen"><span class="std std-ref">earlier</span></a> that memtx does not
&#8220;yield&#8221; on a select request, it yields only on data-change requests. However,
vinyl does yield on a select request, or on an equivalent such as <code class="docutils literal"><span class="pre">get()</span></code> or
<code class="docutils literal"><span class="pre">pairs()</span></code>. This has significance for
<a class="reference internal" href="#atomic-cooperative-multitasking"><span class="std std-ref">cooperative multitasking</span></a>.</p>
</div>
<div class="section" id="vinyl-features">
<h3>3.6.2. Vinyl features<a class="headerlink" href="#vinyl-features" title="Ссылка на этот заголовок">¶</a></h3>
<ul class="simple">
<li>Full ACID compliance</li>
<li>Multi-Version Concurrency Control (MVCC)</li>
<li>Pure Append-Only</li>
<li>Multi-threaded (Client access and Engine scalability)</li>
<li>Multi-databases support (Single environment and WAL)</li>
<li>Multi-Statement and Single-Statement Transactions (Snapshot Isolation (SI),
multi-databases)</li>
<li>Asynchronous or synchronous transaction execution (Callback triggered versus
blocking)</li>
<li>Separate storage formats: key-value (Default), or document (Keys are part of
value)</li>
<li>Update without read</li>
<li>Consistent Cursors</li>
<li>Prefix search</li>
<li>Point-in-Time Snapshots</li>
<li>Versional database creation and asynchronous shutdown/drop</li>
<li>Asynchronous Online/Hot Backup</li>
<li>Compression (Per region, both lz4 and zstd are supported)</li>
<li>Metadata Compression (By default)</li>
<li>Key Compression (Compress key duplicates, including suffixes)</li>
<li>Easy to use (Minimalist API)</li>
<li>Easy to integrate (Native support of using as storage engine)</li>
<li>Easy to write bindings (Very FFI-friendly, API designed to be stable in future)</li>
<li>Easy to build in (Amalgamated, compiles into two C files)</li>
<li>Event loop friendly</li>
<li>Zero-Configuration (Tuned by default)</li>
<li>Implemented as a small library <strong>written in C</strong> with zero dependencies</li>
<li>BSD Licensed</li>
</ul>
<p>It is appropriate for databases that cannot fit in memory, where access via
secondary keys is not required.</p>
<p>In vinyl terminology:</p>
<ul class="simple">
<li>There is one <strong>Environment</strong>.</li>
<li>An Environment has N <strong>Databases</strong> - a vinyl database is like a Tarantool <cite>space</cite>.</li>
<li>A Database has N <strong>Ranges</strong>.</li>
<li>A Range has one <strong>Range File</strong>.</li>
<li>A Range File has N <strong>Runs</strong>.</li>
<li>A Run has N <strong>Regions</strong> - a vinyl Region is like a B-tree <cite>page</cite>.</li>
<li>A Region has <strong>keys</strong> and <strong>values</strong> - a vinyl key-value is like a Tarantool <cite>tuple</cite>.</li>
</ul>
<p>A key and its associated value are together, so when one accesses a key one gets
the whole tuple. In other words, in vinyl the data is stored in the index. There
are up to two in-memory copies of an index, as well as the copy in the Range File.</p>
<p>For operations that insert or update tuples - called Set operations in vinyl -
vinyl makes changes to in-memory copies of the index, and writes to Tarantool&#8217;s
Write-ahead Log. A scheduler assigns tasks to multiple background threads for
transferring index data from memory to disk, and for reorganizing Runs. To
support transactions, Set operations can be delayed until an explicit commit. If
multiple users access the same tuples simultaneously, the concurrency control
method is <a class="reference external" href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a> and the isolation level is <a class="reference external" href="https://en.wikipedia.org/wiki/Snapshot_isolation">Snapshot</a>.</p>
<p>Formally, in terms of disk accesses, vinyl has the following algorithmic complexity:</p>
<ul class="simple">
<li><strong>Set</strong> - the worst case is O(<em>1</em>) append-only key writes to the Write-Ahead
Log + in-memory Range index searches + in-memory index inserts</li>
<li><strong>Delete</strong> - the worst case is O(<em>1</em>) key writes and in-memory index inserts
(the same as <strong>Set</strong>)</li>
<li><strong>Get</strong> - the worst case is <a class="reference external" href="https://en.wikipedia.org/wiki/Amortized_analysis">amortized</a> O(<em>max_run_count_per_node</em>)
random Region reads from a single Range file, which itself does in-memory index
search + in-memory Region search</li>
<li><strong>Range</strong> - queries, the worst case of full Database scan is amortized
O(<em>total_Region_count</em>) + in-memory key-index searches for each Range</li>
</ul>
</div>
<div class="section" id="under-the-hood">
<h3>3.6.3. А что там &#8220;под капотом&#8221;?<a class="headerlink" href="#under-the-hood" title="Ссылка на этот заголовок">¶</a></h3>
<p>In this section, to illustrate internals, we will discuss this example:</p>
<ol class="arabic simple">
<li>filling an empty database with one million tuples (we&#8217;ll call them &#8220;keys&#8221; to
emphasize the indexed nature)</li>
<li>reading all stored tuples in the original order.</li>
</ol>
<div class="section" id="inserting-the-first-200-000-keys">
<h4>3.6.3.1. Inserting the first 200.000 keys<a class="headerlink" href="#inserting-the-first-200-000-keys" title="Ссылка на этот заголовок">¶</a></h4>
<p>During the first 200,000 Set operations, inserted keys first go to the
in-memory index. To maintain persistence, information about each Set
operation is written to Tarantool&#8217;s Write-ahead Log.</p>
<img alt="i1.png" class="align-center" src="../../_images/i1.png" />
<p>At this point, we have keys in an in-memory index and records in the Write-ahead Log.</p>
</div>
<div class="section" id="inserting-the-next-300-000-keys">
<h4>3.6.3.2. Inserting the next 300.000 keys<a class="headerlink" href="#inserting-the-next-300-000-keys" title="Ссылка на этот заголовок">¶</a></h4>
<p>As the in-memory index becomes too large for available memory, the index must be
copied from memory to disk. The on-disk copy of the in-memory index is called a
Run. To save the Run, a new file is created, the Range File. We will call
it <strong>db file</strong> for this example.</p>
<p>The scheduler wakes a worker thread in the background, a Run Creation Thread.
The thread creates a second in-memory index. If there are Set operations taking
place while the thread is working, their contention effect will be small because
they will operate on the second in-memory index.</p>
<img alt="i2.png" class="align-center" src="../../_images/i2.png" />
<p>When the Run Creation Thread finishes the task, the first in-memory index is
freed.</p>
<img alt="i3.png" class="align-center" src="../../_images/i3.png" />
</div>
<div class="section" id="inserting-the-next-200-000-keys">
<h4>3.6.3.3. Inserting the next 200.000 keys<a class="headerlink" href="#inserting-the-next-200-000-keys" title="Ссылка на этот заголовок">¶</a></h4>
<p>Several times, the in-memory index becomes too large and a Run Creation
Thread transfers the keys to a Run. The Runs have been appended to the
end of db file. The number of created Runs becomes large.</p>
<img alt="i4.png" class="align-center" src="../../_images/i4.png" />
<p>There is a user-settable maximum number of Runs per Range. When the number of
Runs reaches this maximum, the vinyl scheduler wakes a <strong>Compaction Thread</strong>
for the db file. The Compaction Thread merges the keys in all the Runs, and
creates one or more new db files.</p>
<img alt="i5.png" class="align-center" src="../../_images/i5.png" />
<p>Now there are multiple pairs of in-memory indexes, and each pair has an
associated db file. The combination of the in-memory indexes and the db file is
called a <strong>Range</strong>, and the db file is called a <strong>Range File</strong>.</p>
<img alt="i6.png" class="align-center" src="../../_images/i6.png" />
<p>Thus the contents of a Range are: a range of sorted key values, stored in Runs
of a Range File and (when necessary) in memory. Since the ranges do not overlap,
each Range can be handled independently. Therefore, while one of the background
threads is working on Range 1, another background thread can be working on Range 2,
without contention. That means that all the background operations (Run Creation,
Compaction, Garbage Collection, and Backup) can take place in parallel on multiple
threads.</p>
<p>The foregoing explanation will now be repeated with different wording.</p>
<p>Before the Compaction there was one Range, which was created automatically when
the Database was initialized. The Range had:</p>
<ol class="loweralpha simple">
<li>an in-memory index with some keys in it,</li>
<li>a Range File with several Runs,</li>
<li>a Write-Ahead Log file recording the Set operations, in the order they happened.</li>
</ol>
<p>The number of Runs became too big, so the vinyl scheduler starts the
Compaction Thread and creates two new Ranges.</p>
<img alt="i7.png" class="align-center" src="../../_images/i7.png" />
<p>So, each of the two new Range Files contains half of the keys that were in the
original Range. The Range&#8217;s in-memory indexes are split in the same way.</p>
<p>After the splitting, vinyl must take into account that: while the Compaction
was going on in the background, there might have been more Set operations taking
place in parallel. These Set operations would have changed one of the in-memory
indexes, and these changes too will be merged.</p>
<p>When the Compaction Thread finishes, the original Range is deleted, and
information about the new Ranges is inserted into an in-memory <strong>Range Index</strong>.</p>
<img alt="i8.png" class="align-center" src="../../_images/i8.png" />
<p>This Range Index is used for all Set operations and all searches. Since the Range
Index has the minimum and maximum key values that are in each Range, it is
straightforward to scan it to find what Range would contain a particular key value.</p>
<img alt="i9.png" class="align-center" src="../../_images/i9.png" />
</div>
<div class="section" id="inserting-the-last-300-000-keys">
<h4>3.6.3.4. Inserting the last 300.000 keys<a class="headerlink" href="#inserting-the-last-300-000-keys" title="Ссылка на этот заголовок">¶</a></h4>
<p>The final 300,000 Set operations take place; the background threads continue to
create new Runs and do more Compactions. After the millionth insertion, the
Database has four Ranges.</p>
<img alt="i10.png" class="align-center" src="../../_images/i10.png" />
<p>The inserting is done. Now, because the words &#8220;memory&#8221; and &#8220;disk&#8221; have appeared
in this explanation several times, here are a few words about how vinyl is
designed to use these resources most efficiently:</p>
<ul class="simple">
<li>If there is more memory available, then Run Creation and Compaction will be
less frequent, and there will be fewer disk accesses.</li>
<li>The best vinyl performance will occur if there is no setting of a memory limit,
but this must be balanced against other considerations, such as requirements
for the memtx storage engine. If there is a setting of a memory limit, the
vinyl scheduler will give priority to the Ranges that have the largest
in-memory indexes, so that the largest memory blocks are freed first.</li>
<li>To make the most of hard drives and Flash, vinyl will delay operations that
require disk access (except the writing of the Write-ahead Log which is
specially tunable), so that the accesses are done in large sequential blocks.</li>
<li>Overwriting does not occur; vinyl is an &#8220;append-only&#8221; engine.</li>
</ul>
</div>
<div class="section" id="reading-million-keys">
<h4>3.6.3.5. Reading million keys<a class="headerlink" href="#reading-million-keys" title="Ссылка на этот заголовок">¶</a></h4>
<p>We will now start to read the million rows in the order that they were inserted,
which was random.</p>
<img alt="i12.png" class="align-center" src="../../_images/i12.png" />
<p>During the Get (search), vinyl first finds the correct Range by looking in the
Range Index. Then it searches the Range&#8217;s first in-memory index, and/or the Range&#8217;s
second in-memory index, and/or each Run of the Range, starting from the end of
the Range File.</p>
<p>Remember that a Run is divided into Regions, which are like what would be
called &#8220;pages&#8221; or &#8220;blocks&#8221; in a B-tree. For each Run, there is a list of the
Regions and their minimum/maximum key values - the Region Index - as well as
some metadata.</p>
<img alt="i13.png" class="align-center" src="../../_images/i13.png" />
<p>Region Indexes are loaded into memory when the Database is opened. Since the
Database&#8217;s Range Index and the Region Indexes are normally in-memory, searching
and retrieving a tuple might require only zero or one disk accesses. However,
when memory is limited and there are many Runs, search time may rise.
For each additional Run there is a possible additional disk access during a
search. Also, it is impossible to maintain memory limits without doing a Run
Creation process, because new Set operations might occur more quickly than the
Compaction process can run.</p>
<img alt="i14.png" class="align-center" src="../../_images/i14.png" />
<p>Vinyl is read optimized. It is very likely that the most recently created
Runs (hot data) will be in the file system cache. The scheduler will give
priority to the Ranges which have the largest in-memory indexes and the most
Runs.</p>
<p>The scheduler may also try to arrange that a Range will have only one Run,
which will ensure the average number of disk seeks for each search is O(<em>1</em>).</p>
</div>
</div>
</div>
</div>


          
          
  <div id="disqus_thread"></div>
  <script>
    // DON'T EDIT
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//tarantooldb.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">
      comments powered by Disqus.
    </a>
  </noscript>

          
  
    
      <div class="b-page_over-tail">
    
    
      <div class="b-page_over-prev">
        <a href="../user_guide_getting_started.html"
           class="b-prev b-ellipsis"
           title="2. Начало работы">2. Начало работы</a>
      </div>
    
    <div class="b-page_over-lang">
      <ul class="b-page_over-lang-list">
        <li class="b-page_over-lang-item">
          <a href="../../_sources/book/box/index.txt"
             class="b-page_over-lang-url"> Source </a>
        </li>
      </ul>
    </div>
    
      <div class="b-page_over-next">
        <a href="../app_server.html"
           class="b-next b-ellipsis"
           title="4. Сервер приложений">4. Сервер приложений</a>
      </div>
    
    </div>
  
</div>
      </div>
    </div>
  

        </div>
        </div>

    <!-- FOOTER > -->
    
<footer class="b-footer">
  <div class="b-footer-wrapper">
    <nav class="b-footer_menu">
      
  <ul class="b-menu">
    
      <li class="b-menu-item">
        <a href="/" class="b-menu-item-url">Overview</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/doc/" class="b-menu-item-url">Documentation</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/download.html" class="b-menu-item-url">Download</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

      <div class="b-footer-other">
        <a href="http://15.tarantool.org">1.5 web site and downloads</a>
      </div>
    </nav>
  </div>
</footer>

    <!-- < FOOTER -->
    <div id="mobile-checker"></div>
  </div>
  </body>
</html>

